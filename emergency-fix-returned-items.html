<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·Šæ€¥ä¿®å¾© returned_items è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 2rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #F44336; }
        .warning { border-left: 4px solid #FF9800; }
        .info { border-left: 4px solid #2196F3; }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #45a049; }
        button.danger { background: #F44336; }
        button.danger:hover { background: #d32f2f; }
        
        .sql-code {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .log {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .log .success { color: #4CAF50; }
        .log .error { color: #F44336; }
        .log .warning { color: #FF9800; }
        .log .info { color: #2196F3; }
    </style>
</head>
<body>
    <h1>ğŸš¨ ç·Šæ€¥ä¿®å¾© returned_items è¡¨</h1>
    
    <div class="section error">
        <h3>âš ï¸ ç·Šæ€¥ç‹€æ³</h3>
        <p>ç”±æ–¼ <code>returned_items</code> è¡¨çµæ§‹å•é¡Œå°è‡´ã€Œæ‰¾åˆ°ä¸»äººã€åŠŸèƒ½ç„¡æ³•æ­£å¸¸é‹ä½œã€‚</p>
        <p><strong>å»ºè­°ç«‹å³åŸ·è¡Œä¿®å¾©ï¼</strong></p>
        
        <button onclick="emergencyFix()" class="danger">ğŸš¨ ç«‹å³ä¿®å¾©</button>
        <button onclick="testCurrentTable()">ğŸ” æª¢æŸ¥ç¾ç‹€</button>
        <button onclick="testInsertion()">ğŸ§ª æ¸¬è©¦æ’å…¥</button>
    </div>

    <div class="section info">
        <h3>ğŸ› ï¸ ä¿®å¾©æ–¹æ¡ˆ</h3>
        <p>æ­¤å·¥å…·å°‡æœƒï¼š</p>
        <ol>
            <li>é‡æ–°å‰µå»º <code>returned_items</code> è¡¨ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰</li>
            <li>åªåŒ…å«å¿…è¦çš„æ¬„ä½</li>
            <li>ç¦ç”¨ RLS ç¢ºä¿æ­£å¸¸é‹ä½œ</li>
            <li>è¨­ç½®é©ç•¶çš„æ¬Šé™</li>
            <li>æ¸¬è©¦æ’å…¥åŠŸèƒ½</li>
        </ol>
        
        <div class="warning">
            <h4>âš ï¸ æ³¨æ„äº‹é …</h4>
            <p>æ­¤æ“ä½œæœƒé‡æ–°å‰µå»ºè¡¨æ ¼ï¼Œå¦‚æœå·²æœ‰æ­¸é‚„è¨˜éŒ„å°‡æœƒè¢«æ¸…é™¤ã€‚</p>
            <p>å»ºè­°åœ¨æ¸¬è©¦ç’°å¢ƒä¸­å…ˆåŸ·è¡Œã€‚</p>
        </div>
    </div>

    <div class="section">
        <h3>ğŸ“‹ æ‰‹å‹•åŸ·è¡Œ SQL</h3>
        <p>å¦‚æœè‡ªå‹•ä¿®å¾©å¤±æ•—ï¼Œè«‹åœ¨ Supabase SQL Editor ä¸­æ‰‹å‹•åŸ·è¡Œä»¥ä¸‹ SQLï¼š</p>
        
        <div class="sql-code">-- é‡æ–°å‰µå»º returned_items è¡¨
DROP TABLE IF EXISTS returned_items;

CREATE TABLE returned_items (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    found_location VARCHAR(50) NOT NULL,
    claimer_name VARCHAR(50) NOT NULL,
    description TEXT,
    story TEXT,
    finder_name VARCHAR(50),
    found_time TIMESTAMP WITH TIME ZONE,
    image_url TEXT,
    image_data TEXT,
    original_lost_item_id INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç¦ç”¨ RLS
ALTER TABLE returned_items DISABLE ROW LEVEL SECURITY;

-- è¨­ç½®æ¬Šé™
GRANT ALL ON returned_items TO anon;
GRANT ALL ON returned_items TO authenticated;
GRANT USAGE, SELECT ON SEQUENCE returned_items_id_seq TO anon;
GRANT USAGE, SELECT ON SEQUENCE returned_items_id_seq TO authenticated;

-- åˆ·æ–° schema
NOTIFY pgrst, 'reload schema';</div>
        
        <button onclick="copySQL()">ğŸ“‹ è¤‡è£½ SQL</button>
    </div>

    <div class="section">
        <h3>ğŸ“ ä¿®å¾©æ—¥èªŒ</h3>
        <div id="log" class="log">æº–å‚™åŸ·è¡Œç·Šæ€¥ä¿®å¾©...\n</div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <script src="config.js"></script>
    <script>
        // åˆå§‹åŒ– Supabase
        let supabase;
        
        if (typeof window.LostItemsConfig !== 'undefined') {
            const config = window.LostItemsConfig.config;
            supabase = window.supabase.createClient(config.supabase.url, config.supabase.anonKey);
        } else {
            const supabaseUrl = 'https://oytgyizrtuqyxvxtgrlv.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dGd5aXpydHVxeXh2eHRncmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUwNjgsImV4cCI6MjA3MTE1MTA2OH0.OiHI8KP-p0OOKo6XvPOARsz0pYqWBEMowJbL0wOzrQs';
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testCurrentTable() {
            log('ğŸ” æ¸¬è©¦ç•¶å‰ returned_items è¡¨ç‹€æ…‹...', 'info');
            
            try {
                const { data, error } = await supabase
                    .from('returned_items')
                    .select('*')
                    .limit(1);

                if (error) {
                    if (error.code === 'PGRST116') {
                        log('âŒ returned_items è¡¨ä¸å­˜åœ¨', 'error');
                    } else {
                        log(`âŒ æŸ¥è©¢éŒ¯èª¤: ${error.message}`, 'error');
                    }
                } else {
                    log('âœ… returned_items è¡¨å­˜åœ¨ä¸¦å¯æŸ¥è©¢', 'success');
                    log(`ç•¶å‰è¨˜éŒ„æ•¸: ${data.length}`, 'info');
                }
            } catch (err) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${err.message}`, 'error');
            }
        }

        async function emergencyFix() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦é‡æ–°å‰µå»º returned_items è¡¨å—ï¼Ÿ\né€™æœƒæ¸…é™¤ç¾æœ‰çš„æ­¸é‚„è¨˜éŒ„ï¼')) {
                return;
            }
            
            log('ğŸš¨ é–‹å§‹ç·Šæ€¥ä¿®å¾© returned_items è¡¨...', 'warning');
            
            try {
                // å˜—è©¦åˆªé™¤ç¾æœ‰è¡¨æ ¼ï¼ˆå¯èƒ½æœƒå¤±æ•—ï¼Œä½†æ²’é—œä¿‚ï¼‰
                log('ğŸ—‘ï¸ å˜—è©¦åˆªé™¤ç¾æœ‰è¡¨æ ¼...', 'info');
                await supabase.rpc('exec_sql', { 
                    sql_query: 'DROP TABLE IF EXISTS returned_items;' 
                });
                
                // å‰µå»ºæ–°è¡¨æ ¼
                log('ğŸ—ï¸ å‰µå»ºæ–°çš„ returned_items è¡¨...', 'info');
                const createTableSQL = `
                    CREATE TABLE returned_items (
                        id SERIAL PRIMARY KEY,
                        name VARCHAR(100) NOT NULL,
                        found_location VARCHAR(50) NOT NULL,
                        claimer_name VARCHAR(50) NOT NULL,
                        description TEXT,
                        story TEXT,
                        finder_name VARCHAR(50),
                        found_time TIMESTAMP WITH TIME ZONE,
                        image_url TEXT,
                        image_data TEXT,
                        original_lost_item_id INTEGER,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    );
                `;
                
                const { error: createError } = await supabase.rpc('exec_sql', { 
                    sql_query: createTableSQL 
                });
                
                if (createError) {
                    log(`âŒ å‰µå»ºè¡¨æ ¼å¤±æ•—: ${createError.message}`, 'error');
                    return;
                }
                
                log('âœ… è¡¨æ ¼å‰µå»ºæˆåŠŸ', 'success');
                
                // ç¦ç”¨ RLS
                log('ğŸ”“ ç¦ç”¨ RLS...', 'info');
                await supabase.rpc('exec_sql', { 
                    sql_query: 'ALTER TABLE returned_items DISABLE ROW LEVEL SECURITY;' 
                });
                
                // è¨­ç½®æ¬Šé™
                log('ğŸ”‘ è¨­ç½®æ¬Šé™...', 'info');
                const permissionSQL = `
                    GRANT ALL ON returned_items TO anon;
                    GRANT ALL ON returned_items TO authenticated;
                    GRANT USAGE, SELECT ON SEQUENCE returned_items_id_seq TO anon;
                    GRANT USAGE, SELECT ON SEQUENCE returned_items_id_seq TO authenticated;
                `;
                
                await supabase.rpc('exec_sql', { 
                    sql_query: permissionSQL 
                });
                
                // åˆ·æ–° schema
                log('ğŸ”„ åˆ·æ–° schema cache...', 'info');
                await supabase.rpc('exec_sql', { 
                    sql_query: "NOTIFY pgrst, 'reload schema';" 
                });
                
                log('ğŸ‰ ç·Šæ€¥ä¿®å¾©å®Œæˆï¼', 'success');
                log('ğŸ’¡ è«‹ç­‰å¾… 30 ç§’å¾Œæ¸¬è©¦æ’å…¥åŠŸèƒ½', 'info');
                
                // 30 ç§’å¾Œè‡ªå‹•æ¸¬è©¦
                setTimeout(testInsertion, 30000);
                
            } catch (err) {
                log(`âŒ ç·Šæ€¥ä¿®å¾©å¤±æ•—: ${err.message}`, 'error');
                log('ğŸ’¡ è«‹æ‰‹å‹•åŸ·è¡Œ SQL èªå¥', 'warning');
            }
        }

        async function testInsertion() {
            log('ğŸ§ª æ¸¬è©¦æ’å…¥åŠŸèƒ½...', 'info');
            
            try {
                const testData = {
                    name: 'æ¸¬è©¦å¤±ç‰©',
                    found_location: 'æ¸¬è©¦åœ°é»',
                    claimer_name: 'æ¸¬è©¦ä¸»äºº',
                    description: 'æ¸¬è©¦æè¿°'
                };

                const { data, error } = await supabase
                    .from('returned_items')
                    .insert([testData])
                    .select();

                if (error) {
                    log(`âŒ æ’å…¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                    
                    if (error.message.includes('schema cache')) {
                        log('ğŸ’¡ Schema cache æœªæ›´æ–°ï¼Œè«‹ç¨ç­‰å†è©¦', 'warning');
                    }
                } else {
                    log('âœ… æ’å…¥æ¸¬è©¦æˆåŠŸï¼', 'success');
                    log(`æ’å…¥è¨˜éŒ„ ID: ${data[0].id}`, 'info');
                    
                    // æ¸…ç†æ¸¬è©¦è³‡æ–™
                    await supabase
                        .from('returned_items')
                        .delete()
                        .eq('id', data[0].id);
                    
                    log('ğŸ—‘ï¸ æ¸¬è©¦è³‡æ–™å·²æ¸…ç†', 'info');
                    log('ğŸŠ returned_items è¡¨å·²æº–å‚™å°±ç·’ï¼', 'success');
                }

            } catch (err) {
                log(`âŒ æ¸¬è©¦æ’å…¥ç•°å¸¸: ${err.message}`, 'error');
            }
        }

        function copySQL() {
            const sqlText = `-- é‡æ–°å‰µå»º returned_items è¡¨
DROP TABLE IF EXISTS returned_items;

CREATE TABLE returned_items (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    found_location VARCHAR(50) NOT NULL,
    claimer_name VARCHAR(50) NOT NULL,
    description TEXT,
    story TEXT,
    finder_name VARCHAR(50),
    found_time TIMESTAMP WITH TIME ZONE,
    image_url TEXT,
    image_data TEXT,
    original_lost_item_id INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç¦ç”¨ RLS
ALTER TABLE returned_items DISABLE ROW LEVEL SECURITY;

-- è¨­ç½®æ¬Šé™
GRANT ALL ON returned_items TO anon;
GRANT ALL ON returned_items TO authenticated;
GRANT USAGE, SELECT ON SEQUENCE returned_items_id_seq TO anon;
GRANT USAGE, SELECT ON SEQUENCE returned_items_id_seq TO authenticated;

-- åˆ·æ–° schema
NOTIFY pgrst, 'reload schema';`;

            navigator.clipboard.writeText(sqlText).then(() => {
                alert('âœ… SQL å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
                log('ğŸ“‹ SQL å·²è¤‡è£½åˆ°å‰ªè²¼æ¿', 'success');
            }).catch(() => {
                log('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error');
            });
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç‹€æ…‹
        window.addEventListener('load', function() {
            log('ğŸš¨ ç·Šæ€¥ä¿®å¾©å·¥å…·å·²è¼‰å…¥', 'warning');
            testCurrentTable();
        });
    </script>
</body>
</html>
