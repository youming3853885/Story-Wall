<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦æ•…äº‹ç”Ÿæˆå’Œå„²å­˜åŠŸèƒ½</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 1rem 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem 0.5rem 0.5rem 0;
            width: auto;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        input, select {
            width: 100%;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .story-preview {
            background: #f9f9f9;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #4CAF50;
            font-style: italic;
            line-height: 1.6;
        }
        .log {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }
        .success { color: #4CAF50; }
        .error { color: #F44336; }
        .warning { color: #FF9800; }
        .info { color: #2196F3; }
        .result-item {
            background: #f0f8ff;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            border-left: 3px solid #2196F3;
        }
    </style>
</head>
<body>
    <h1>ğŸ“– æ¸¬è©¦æ•…äº‹ç”Ÿæˆå’Œå„²å­˜åŠŸèƒ½</h1>
    
    <div class="test-box">
        <h3>ğŸ² æ•…äº‹ç”Ÿæˆæ¸¬è©¦</h3>
        <input type="text" id="itemName" placeholder="å¤±ç‰©åç¨±" value="ç´…è‰²æ°´å£º">
        <select id="location">
            <option value="æ“å ´">æ“å ´</option>
            <option value="åœ–æ›¸é¤¨">åœ–æ›¸é¤¨</option>
            <option value="å·å ‚">å·å ‚</option>
            <option value="æ•™å®¤">æ•™å®¤</option>
            <option value="æ ¡å¤–">æ ¡å¤–</option>
        </select>
        
        <button onclick="generateStoryPreview()">ğŸ­ ç”Ÿæˆæ•…äº‹é è¦½</button>
        <button onclick="generateMultipleStories()">ğŸª ç”Ÿæˆå¤šå€‹æ•…äº‹ç¯„ä¾‹</button>
        
        <div id="storyPreview"></div>
    </div>

    <div class="test-box">
        <h3>ğŸ’¾ å®Œæ•´ä¸Šå‚³å’Œå„²å­˜æ¸¬è©¦</h3>
        <p>æ¸¬è©¦æ•…äº‹ç”Ÿæˆ â†’ è³‡æ–™åº«å„²å­˜ â†’ é©—è­‰ story æ¬„ä½</p>
        
        <button onclick="testFullUploadWithStory()">ğŸš€ æ¸¬è©¦å®Œæ•´ä¸Šå‚³æµç¨‹</button>
        
        <div id="uploadResults"></div>
    </div>

    <div class="test-box">
        <h3>ğŸ” æŸ¥çœ‹å·²å„²å­˜çš„æ•…äº‹</h3>
        <button onclick="viewStoredStories()">ğŸ‘ï¸ æŸ¥çœ‹è³‡æ–™åº«ä¸­çš„æ•…äº‹</button>
        
        <div id="storedStories"></div>
    </div>

    <div class="test-box">
        <h4>ğŸ“ åŸ·è¡Œæ—¥èªŒ</h4>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <script>
        const supabaseUrl = 'https://oytgyizrtuqyxvxtgrlv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dGd5aXpydHVxeXh2eHRncmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUwNjgsImV4cCI6MjA3MTE1MTA2OH0.OiHI8KP-p0OOKo6XvPOARsz0pYqWBEMowJbL0wOzrQs';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // è¤‡è£½ script.js ä¸­çš„æ•…äº‹ç”Ÿæˆå‡½æ•¸
        function generateStoryLocally(itemName, location) {
            const templates = [
                `å“ˆå›‰ï¼æˆ‘æ˜¯${itemName}ï¼ä»Šå¤©æˆ‘åœ¨${location}è¢«ç™¼ç¾äº†ã€‚æˆ‘å¥½æƒ³å¿µæˆ‘çš„å°ä¸»äººï¼Œå¸Œæœ›ä»–å¿«ä¾†å¸¶æˆ‘å›å®¶ã€‚æˆ‘æœƒä¹–ä¹–åœ°ç­‰å¾…ï¼Œç›´åˆ°æˆ‘å€‘é‡æ–°ç›¸é‡çš„é‚£ä¸€åˆ»ï¼`,
                `å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯${itemName}ï¼æˆ‘åœ¨${location}å­¤å–®åœ°ç­‰å¾…è‘—ã€‚æˆ‘è¨˜å¾—å°ä¸»äººç¸½æ˜¯å¾ˆæ„›è­·æˆ‘ï¼Œç¾åœ¨æˆ‘å¥½æƒ³å¿µé‚£æº«æš–çš„æ„Ÿè¦ºã€‚å¦‚æœä½ èªè­˜æˆ‘çš„ä¸»äººï¼Œè«‹å‘Šè¨´ä»–æˆ‘åœ¨é€™è£¡ç­‰ä»–ï¼`,
                `å—¨ï¼æˆ‘æ˜¯${itemName}ï¼æˆ‘åœ¨${location}å’Œå°ä¸»äººèµ°æ•£äº†ã€‚æˆ‘æ¯å¤©éƒ½åœ¨æƒ³å¿µæˆ‘å€‘ä¸€èµ·åº¦éçš„å¿«æ¨‚æ™‚å…‰ã€‚æˆ‘ç›¸ä¿¡å°ä¸»äººä¸€å®šå¾ˆæ“”å¿ƒæˆ‘ï¼Œå¿«ä¾†æ‰¾æˆ‘å§ï¼`,
                `ä½ å¥½ï¼æˆ‘æ˜¯${itemName}ï¼æˆ‘åœ¨${location}è¢«å¥½å¿ƒäººç™¼ç¾ã€‚é›–ç„¶ç¾åœ¨å¾ˆå­¤å–®ï¼Œä½†æˆ‘ç›¸ä¿¡å°ä¸»äººä¸€å®šæœƒä¾†æ‰¾æˆ‘çš„ã€‚æˆ‘æœƒè€å¿ƒç­‰å¾…ï¼Œå› ç‚ºæˆ‘çŸ¥é“æˆ‘å€‘çš„ç·£åˆ†é‚„æ²’çµæŸï¼`
            ];
            
            return templates[Math.floor(Math.random() * templates.length)];
        }

        function generateStoryPreview() {
            const itemName = document.getElementById('itemName').value;
            const location = document.getElementById('location').value;
            
            if (!itemName) {
                log('è«‹å¡«å¯«å¤±ç‰©åç¨±ï¼', 'error');
                return;
            }
            
            log(`ğŸ­ ç‚º "${itemName}" åœ¨ "${location}" ç”Ÿæˆæ•…äº‹...`);
            
            const story = generateStoryLocally(itemName, location);
            
            document.getElementById('storyPreview').innerHTML = `
                <div class="story-preview">
                    <h4>ğŸ“– ç”Ÿæˆçš„æ•…äº‹</h4>
                    <p>${story}</p>
                    <small>å¤±ç‰©ï¼š${itemName} | åœ°é»ï¼š${location}</small>
                </div>
            `;
            
            log(`âœ… æ•…äº‹ç”ŸæˆæˆåŠŸï¼š${story.substring(0, 50)}...`, 'success');
        }

        function generateMultipleStories() {
            const itemName = document.getElementById('itemName').value;
            const location = document.getElementById('location').value;
            
            if (!itemName) {
                log('è«‹å¡«å¯«å¤±ç‰©åç¨±ï¼', 'error');
                return;
            }
            
            log(`ğŸª ç‚º "${itemName}" ç”Ÿæˆå¤šå€‹æ•…äº‹ç¯„ä¾‹...`);
            
            let html = '<h4>ğŸ­ å¤šå€‹æ•…äº‹ç¯„ä¾‹</h4>';
            
            for (let i = 1; i <= 4; i++) {
                const story = generateStoryLocally(itemName, location);
                html += `
                    <div class="story-preview">
                        <strong>æ•…äº‹ç¯„ä¾‹ ${i}ï¼š</strong>
                        <p>${story}</p>
                    </div>
                `;
            }
            
            document.getElementById('storyPreview').innerHTML = html;
            log('âœ… ç”Ÿæˆäº† 4 å€‹æ•…äº‹ç¯„ä¾‹', 'success');
        }

        async function testFullUploadWithStory() {
            clearLog();
            log('ğŸš€ é–‹å§‹æ¸¬è©¦å®Œæ•´ä¸Šå‚³æµç¨‹ï¼ˆåŒ…å«æ•…äº‹å„²å­˜ï¼‰...');
            
            const itemName = document.getElementById('itemName').value;
            const location = document.getElementById('location').value;
            
            if (!itemName) {
                log('è«‹å¡«å¯«å¤±ç‰©åç¨±ï¼', 'error');
                return;
            }
            
            try {
                // æ­¥é©Ÿ 1: ç”Ÿæˆæ•…äº‹
                log('ğŸ“– æ­¥é©Ÿ 1: ç”Ÿæˆ AI æ•…äº‹...');
                const story = generateStoryLocally(itemName, location);
                log(`âœ… æ•…äº‹ç”Ÿæˆå®Œæˆï¼š${story.substring(0, 100)}...`, 'success');
                
                // æ­¥é©Ÿ 2: æº–å‚™è³‡æ–™
                log('ğŸ“Š æ­¥é©Ÿ 2: æº–å‚™è³‡æ–™...');
                const itemData = {
                    name: itemName,
                    description: 'é€™æ˜¯æ•…äº‹å„²å­˜æ¸¬è©¦çš„æè¿°',
                    found_location: location,
                    story: story, // é‡é»ï¼šæ•…äº‹å„²å­˜åˆ° story æ¬„ä½
                    finder_name: 'æ•…äº‹æ¸¬è©¦å“¡',
                    found_time: new Date().toISOString(),
                    image_data: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNmMGYwZjAiLz48L3N2Zz4='
                };
                
                log('æº–å‚™æ’å…¥çš„è³‡æ–™ï¼ˆåŒ…å« story æ¬„ä½ï¼‰:', 'info');
                log(`name: ${itemData.name}`, 'info');
                log(`found_location: ${itemData.found_location}`, 'info');
                log(`story: ${itemData.story.substring(0, 50)}...`, 'info');
                
                // æ­¥é©Ÿ 3: æ’å…¥è³‡æ–™åº«
                log('ğŸ’¾ æ­¥é©Ÿ 3: æ’å…¥è³‡æ–™åˆ° lost_items è¡¨...');
                const { data, error } = await supabase
                    .from('lost_items')
                    .insert([itemData])
                    .select();
                
                if (error) {
                    log(`âŒ è³‡æ–™åº«æ’å…¥å¤±æ•—: ${error.message}`, 'error');
                    log(`éŒ¯èª¤ä»£ç¢¼: ${error.code}`, 'error');
                    
                    document.getElementById('uploadResults').innerHTML = `
                        <div class="result-item" style="border-left-color: #F44336;">
                            <h4>âŒ æ’å…¥å¤±æ•—</h4>
                            <p><strong>éŒ¯èª¤ï¼š</strong>${error.message}</p>
                            <p><strong>éŒ¯èª¤ä»£ç¢¼ï¼š</strong>${error.code}</p>
                            <p>å¯èƒ½éœ€è¦å…ˆä¿®å¾©è³‡æ–™åº«çµæ§‹ï¼Œè«‹åŸ·è¡Œ fix-table-names.html</p>
                        </div>
                    `;
                    return;
                }
                
                log(`âœ… è³‡æ–™æ’å…¥æˆåŠŸï¼è¨˜éŒ„ ID: ${data[0].id}`, 'success');
                
                // æ­¥é©Ÿ 4: é©—è­‰æ•…äº‹æ˜¯å¦æ­£ç¢ºå„²å­˜
                log('ğŸ” æ­¥é©Ÿ 4: é©—è­‰æ•…äº‹æ˜¯å¦æ­£ç¢ºå„²å­˜åˆ° story æ¬„ä½...');
                const { data: verifyData, error: verifyError } = await supabase
                    .from('lost_items')
                    .select('id, name, found_location, story, created_at')
                    .eq('id', data[0].id)
                    .single();
                
                if (verifyError) {
                    log(`âš ï¸ é©—è­‰æŸ¥è©¢å¤±æ•—: ${verifyError.message}`, 'warning');
                } else {
                    log('âœ… æ•…äº‹æ¬„ä½é©—è­‰æˆåŠŸï¼', 'success');
                    log(`å„²å­˜çš„æ•…äº‹ï¼š${verifyData.story}`, 'info');
                    
                    // é¡¯ç¤ºçµæœ
                    document.getElementById('uploadResults').innerHTML = `
                        <div class="result-item">
                            <h4>âœ… æ¸¬è©¦æˆåŠŸï¼</h4>
                            <p><strong>è¨˜éŒ„ IDï¼š</strong>${verifyData.id}</p>
                            <p><strong>å¤±ç‰©åç¨±ï¼š</strong>${verifyData.name}</p>
                            <p><strong>ç™¼ç¾åœ°é»ï¼š</strong>${verifyData.found_location}</p>
                            <p><strong>å„²å­˜çš„æ•…äº‹ï¼š</strong></p>
                            <div class="story-preview">${verifyData.story}</div>
                            <p><strong>å»ºç«‹æ™‚é–“ï¼š</strong>${new Date(verifyData.created_at).toLocaleString()}</p>
                        </div>
                    `;
                }
                
                log('ğŸ‰ å®Œæ•´æ¸¬è©¦æˆåŠŸï¼æ•…äº‹å·²æ­£ç¢ºå„²å­˜åˆ° story æ¬„ä½', 'success');
                
                // æ¸…ç†æ¸¬è©¦è³‡æ–™
                log('ğŸ§¹ æ¸…ç†æ¸¬è©¦è³‡æ–™...');
                await supabase.from('lost_items').delete().eq('id', data[0].id);
                log('æ¸¬è©¦è³‡æ–™å·²æ¸…ç†', 'info');
                
            } catch (err) {
                log(`âŒ æ¸¬è©¦éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${err.message}`, 'error');
                
                document.getElementById('uploadResults').innerHTML = `
                    <div class="result-item" style="border-left-color: #F44336;">
                        <h4>âŒ æ¸¬è©¦ç•°å¸¸</h4>
                        <p><strong>éŒ¯èª¤ï¼š</strong>${err.message}</p>
                    </div>
                `;
            }
        }

        async function viewStoredStories() {
            log('ğŸ‘ï¸ æŸ¥çœ‹è³‡æ–™åº«ä¸­å·²å„²å­˜çš„æ•…äº‹...');
            
            try {
                const { data, error } = await supabase
                    .from('lost_items')
                    .select('id, name, found_location, story, created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) {
                    log(`âŒ æŸ¥è©¢å¤±æ•—: ${error.message}`, 'error');
                    
                    document.getElementById('storedStories').innerHTML = `
                        <div class="result-item" style="border-left-color: #F44336;">
                            <h4>âŒ æŸ¥è©¢å¤±æ•—</h4>
                            <p>${error.message}</p>
                        </div>
                    `;
                    return;
                }
                
                if (data.length === 0) {
                    log('â„¹ï¸ è³‡æ–™åº«ä¸­æ²’æœ‰æ•…äº‹è¨˜éŒ„', 'info');
                    
                    document.getElementById('storedStories').innerHTML = `
                        <div class="result-item">
                            <h4>â„¹ï¸ æ²’æœ‰è¨˜éŒ„</h4>
                            <p>è³‡æ–™åº«ä¸­ç›®å‰æ²’æœ‰å¤±ç‰©è¨˜éŒ„</p>
                        </div>
                    `;
                    return;
                }
                
                log(`âœ… æ‰¾åˆ° ${data.length} ç­†è¨˜éŒ„`, 'success');
                
                let html = '<h4>ğŸ“š å·²å„²å­˜çš„æ•…äº‹</h4>';
                data.forEach((item, index) => {
                    html += `
                        <div class="result-item">
                            <h5>${index + 1}. ${item.name} (ID: ${item.id})</h5>
                            <p><strong>åœ°é»ï¼š</strong>${item.found_location}</p>
                            <p><strong>æ™‚é–“ï¼š</strong>${new Date(item.created_at).toLocaleString()}</p>
                            <p><strong>æ•…äº‹ï¼š</strong></p>
                            <div class="story-preview">${item.story || 'ç„¡æ•…äº‹'}</div>
                        </div>
                    `;
                });
                
                document.getElementById('storedStories').innerHTML = html;
                
            } catch (err) {
                log(`âŒ æŸ¥è©¢éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${err.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºèªªæ˜
        window.addEventListener('load', function() {
            log('ğŸ“– æ•…äº‹ç”Ÿæˆæ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
            log('é€™å€‹å·¥å…·å°ˆé–€æ¸¬è©¦ AI æ•…äº‹ç”Ÿæˆå’Œ story æ¬„ä½å„²å­˜åŠŸèƒ½');
        });
    </script>
</body>
</html>
