<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™åº«çµæ§‹ä¿®å¾©</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .result {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #F44336; }
        .info { border-left: 4px solid #2196F3; }
        .warning { border-left: 4px solid #FF9800; }
        pre { background: #f9f9f9; padding: 1rem; border-radius: 4px; font-size: 0.9rem; overflow-x: auto; }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 0.8rem 1.5rem; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #45a049; }
        .sql-code {
            background: #263238;
            color: #eee;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .copy-btn {
            background: #2196F3;
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            margin-left: 1rem;
        }
        .copy-btn:hover { background: #1976D2; }
    </style>
</head>
<body>
    <h1>ğŸ”§ è³‡æ–™åº«çµæ§‹è¨ºæ–·èˆ‡ä¿®å¾©</h1>
    <p>é€™å€‹å·¥å…·æœƒæª¢æŸ¥æ‚¨çš„è³‡æ–™åº«çµæ§‹ï¼Œä¸¦æä¾›å®Œæ•´çš„ä¿®å¾©SQL</p>
    
    <div id="results"></div>
    
    <button onclick="checkSchema()">æª¢æŸ¥è³‡æ–™åº«çµæ§‹</button>
    <button onclick="clearResults()">æ¸…é™¤çµæœ</button>

    <script>
        const supabaseUrl = 'https://oytgyizrtuqyxvxtgrlv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dGd5aXpydHVxeXh2eHRncmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUwNjgsImV4cCI6MjA3MTE1MTA2OH0.OiHI8KP-p0OOKo6XvPOARsz0pYqWBEMowJbL0wOzrQs';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(type, title, content = '') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            let html = `<strong>${title}</strong>`;
            if (content) {
                if (typeof content === 'object') {
                    html += `<pre>${JSON.stringify(content, null, 2)}</pre>`;
                } else {
                    html += `<br/>${content}`;
                }
            }
            div.innerHTML = html;
            document.getElementById('results').appendChild(div);
        }

        function showSQL(title, sql) {
            const div = document.createElement('div');
            div.className = 'result info';
            
            const sqlDiv = document.createElement('div');
            sqlDiv.className = 'sql-code';
            sqlDiv.textContent = sql;
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = 'è¤‡è£½ SQL';
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(sql);
                copyBtn.textContent = 'å·²è¤‡è£½ï¼';
                setTimeout(() => {
                    copyBtn.textContent = 'è¤‡è£½ SQL';
                }, 2000);
            };
            
            div.innerHTML = `<strong>${title}</strong>`;
            div.appendChild(copyBtn);
            div.appendChild(sqlDiv);
            
            document.getElementById('results').appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function checkSchema() {
            clearResults();
            
            log('info', 'ğŸ” é–‹å§‹æª¢æŸ¥è³‡æ–™åº«çµæ§‹...');

            // æœŸæœ›çš„æ¬„ä½çµæ§‹
            const expectedColumns = {
                lost_items: [
                    'id', 'name', 'description', 'image_url', 'image_data',
                    'found_location', 'found_time', 'story', 'finder_name',
                    'created_at', 'updated_at'
                ],
                returned_items: [
                    'id', 'original_lost_item_id', 'name', 'description', 
                    'image_url', 'image_data', 'found_location', 'found_time',
                    'story', 'finder_name', 'claimer_name', 'claim_time',
                    'returned_by', 'created_at', 'notes'
                ]
            };

            // æª¢æŸ¥ lost_items è¡¨çµæ§‹
            log('info', 'æª¢æŸ¥ lost_items è¡¨çµæ§‹...');
            try {
                const { data, error } = await supabase
                    .from('lost_items')
                    .select('*')
                    .limit(1);

                if (error) {
                    log('error', 'âŒ lost_items è¡¨æŸ¥è©¢å¤±æ•—', error.message);
                } else {
                    const currentColumns = data.length > 0 ? Object.keys(data[0]) : [];
                    const missingColumns = expectedColumns.lost_items.filter(col => !currentColumns.includes(col));
                    const extraColumns = currentColumns.filter(col => !expectedColumns.lost_items.includes(col));

                    if (missingColumns.length === 0 && extraColumns.length === 0) {
                        log('success', 'âœ… lost_items è¡¨çµæ§‹æ­£ç¢º', {
                            currentColumns: currentColumns,
                            recordCount: data.length
                        });
                    } else {
                        log('warning', 'âš ï¸ lost_items è¡¨çµæ§‹ä¸å®Œæ•´', {
                            currentColumns: currentColumns,
                            missingColumns: missingColumns,
                            extraColumns: extraColumns
                        });

                        if (missingColumns.length > 0) {
                            generateAlterSQL('lost_items', missingColumns);
                        }
                    }
                }
            } catch (err) {
                log('error', 'âŒ lost_items è¡¨æª¢æŸ¥ç•°å¸¸', err.message);
                // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œæä¾›å‰µå»ºè¡¨çš„SQL
                generateCreateTableSQL('lost_items');
            }

            // æª¢æŸ¥ returned_items è¡¨çµæ§‹
            log('info', 'æª¢æŸ¥ returned_items è¡¨çµæ§‹...');
            try {
                const { data, error } = await supabase
                    .from('returned_items')
                    .select('*')
                    .limit(1);

                if (error) {
                    log('warning', 'âš ï¸ returned_items è¡¨å¯èƒ½ä¸å­˜åœ¨', error.message);
                    generateCreateTableSQL('returned_items');
                } else {
                    const currentColumns = data.length > 0 ? Object.keys(data[0]) : [];
                    const missingColumns = expectedColumns.returned_items.filter(col => !currentColumns.includes(col));

                    if (missingColumns.length === 0) {
                        log('success', 'âœ… returned_items è¡¨çµæ§‹æ­£ç¢º');
                    } else {
                        log('warning', 'âš ï¸ returned_items è¡¨çµæ§‹ä¸å®Œæ•´', {
                            missingColumns: missingColumns
                        });
                        generateAlterSQL('returned_items', missingColumns);
                    }
                }
            } catch (err) {
                log('error', 'âŒ returned_items è¡¨æª¢æŸ¥ç•°å¸¸', err.message);
                generateCreateTableSQL('returned_items');
            }

            log('info', 'âœ… è³‡æ–™åº«çµæ§‹æª¢æŸ¥å®Œæˆï¼è«‹åŸ·è¡Œä¸Šè¿°SQLä¾†ä¿®å¾©å•é¡Œ');
        }

        function generateAlterSQL(tableName, missingColumns) {
            const columnDefinitions = {
                description: 'TEXT',
                image_url: 'TEXT',
                image_data: 'TEXT',
                found_location: 'VARCHAR(50) NOT NULL DEFAULT \'æœªçŸ¥\'',
                found_time: 'TIMESTAMP WITH TIME ZONE DEFAULT NOW()',
                story: 'TEXT',
                finder_name: 'VARCHAR(50)',
                created_at: 'TIMESTAMP WITH TIME ZONE DEFAULT NOW()',
                updated_at: 'TIMESTAMP WITH TIME ZONE DEFAULT NOW()',
                original_lost_item_id: 'INTEGER',
                claimer_name: 'VARCHAR(50)',
                claim_time: 'TIMESTAMP WITH TIME ZONE DEFAULT NOW()',
                returned_by: 'VARCHAR(50)',
                notes: 'TEXT'
            };

            let sql = `-- ç‚º ${tableName} è¡¨æ·»åŠ ç¼ºå°‘çš„æ¬„ä½\n`;
            missingColumns.forEach(column => {
                const definition = columnDefinitions[column] || 'TEXT';
                sql += `ALTER TABLE ${tableName} ADD COLUMN IF NOT EXISTS ${column} ${definition};\n`;
            });

            showSQL(`ğŸ”§ ä¿®å¾© ${tableName} è¡¨çµæ§‹çš„ SQL`, sql);
        }

        function generateCreateTableSQL(tableName) {
            let sql = '';
            
            if (tableName === 'lost_items') {
                sql = `-- å‰µå»º lost_items è¡¨
CREATE TABLE IF NOT EXISTS lost_items (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    image_url TEXT,
    image_data TEXT,
    found_location VARCHAR(50) NOT NULL DEFAULT 'æœªçŸ¥',
    found_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    story TEXT,
    finder_name VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ·»åŠ æ›´æ–°æ™‚é–“è§¸ç™¼å™¨
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_lost_items_updated_at 
    BEFORE UPDATE ON lost_items 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ç¦ç”¨ RLS ä»¥é¿å…æ¬Šé™å•é¡Œ
ALTER TABLE lost_items DISABLE ROW LEVEL SECURITY;`;
            } else if (tableName === 'returned_items') {
                sql = `-- å‰µå»º returned_items è¡¨
CREATE TABLE IF NOT EXISTS returned_items (
    id SERIAL PRIMARY KEY,
    original_lost_item_id INTEGER,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    image_url TEXT,
    image_data TEXT,
    found_location VARCHAR(50) NOT NULL,
    found_time TIMESTAMP WITH TIME ZONE,
    story TEXT,
    finder_name VARCHAR(50),
    claimer_name VARCHAR(50),
    claim_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    returned_by VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    notes TEXT
);

-- ç¦ç”¨ RLS ä»¥é¿å…æ¬Šé™å•é¡Œ
ALTER TABLE returned_items DISABLE ROW LEVEL SECURITY;`;
            }

            showSQL(`ğŸ—ï¸ å‰µå»º ${tableName} è¡¨çš„å®Œæ•´ SQL`, sql);
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œ
        window.addEventListener('load', function() {
            setTimeout(checkSchema, 500);
        });
    </script>
</body>
</html>
