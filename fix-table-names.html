<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¾©è¡¨åç¨±å’Œæ¬„ä½å•é¡Œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .result {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #F44336; }
        .info { border-left: 4px solid #2196F3; }
        .warning { border-left: 4px solid #FF9800; }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 1rem 2rem; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 0.5rem 0;
            width: 100%;
        }
        button:hover { background: #45a049; }
        .sql-command {
            background: #263238;
            color: #eee;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            margin: 1rem 0;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .copy-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0;
            width: auto;
        }
        pre {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ä¿®å¾©è¡¨åç¨±å’Œæ¬„ä½å•é¡Œ</h1>
    
    <div class="result error">
        <h3>âŒ æª¢æ¸¬åˆ°çš„å•é¡Œ</h3>
        <ul>
            <li><strong>è¡¨åç¨±ä¸ç¬¦</strong>ï¼šç¨‹å¼ç¢¼æœŸæœ› "lost_items"ï¼Œä½†å¯¦éš›è¡¨åæ˜¯ "éºå¤±ç‰©è³‡æ–™è¡¨"</li>
            <li><strong>æ¬„ä½åç¨±ä¸ç¬¦</strong>ï¼šç¨‹å¼ç¢¼ä½¿ç”¨è‹±æ–‡æ¬„ä½åï¼Œä½†è¡¨ä½¿ç”¨ä¸­æ–‡æ¬„ä½åï¼ˆå¦‚ "å¤±ç‰©åç¨±"ï¼‰</li>
            <li><strong>ä¸»éµè¡çª</strong>ï¼šduplicate key constraint "éºå¤±ç‰©è³‡æ–™è¡¨_pkey"</li>
        </ul>
    </div>

    <div class="result info">
        <button onclick="checkActualTables()">ğŸ” æª¢æŸ¥å¯¦éš›è¡¨çµæ§‹</button>
        <div id="tableResults"></div>
    </div>

    <div class="result warning" id="fixOptions" style="display: none;">
        <h3>ğŸ› ï¸ ä¿®å¾©æ–¹æ¡ˆé¸æ“‡</h3>
        <p>è«‹é¸æ“‡æ‚¨å¸Œæœ›çš„ä¿®å¾©æ–¹å¼ï¼š</p>
        
        <button onclick="showCreateEnglishTable()">æ–¹æ¡ˆ 1: å‰µå»ºè‹±æ–‡è¡¨åå’Œæ¬„ä½ï¼ˆæ¨è–¦ï¼‰</button>
        <button onclick="showUpdateCodeForChinese()">æ–¹æ¡ˆ 2: ä¿®æ”¹ç¨‹å¼ç¢¼ä»¥é©æ‡‰ä¸­æ–‡è¡¨å</button>
        
        <div id="fixSolution" style="display: none;">
            <h4>ä¿®å¾©æ–¹æ¡ˆ</h4>
            <div class="sql-command" id="sqlCommand"></div>
            <button class="copy-btn" onclick="copySQL()">ğŸ“‹ è¤‡è£½ SQL/ç¨‹å¼ç¢¼</button>
        </div>
    </div>

    <div class="result success" id="testSection" style="display: none;">
        <h3>ğŸ§ª æ¸¬è©¦ä¿®å¾©å¾Œçš„åŠŸèƒ½</h3>
        <button onclick="testWithCorrectTable()">æ¸¬è©¦ä¿®å¾©å¾Œçš„ä¸Šå‚³åŠŸèƒ½</button>
        <div id="testResults"></div>
    </div>

    <script>
        const supabaseUrl = 'https://oytgyizrtuqyxvxtgrlv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dGd5aXpydHVxeXh2eHRncmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUwNjgsImV4cCI6MjA3MTE1MTA2OH0.OiHI8KP-p0OOKo6XvPOARsz0pYqWBEMowJbL0wOzrQs';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function addResult(elementId, type, title, content) {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<h4>${title}</h4>${content}`;
            document.getElementById(elementId).appendChild(div);
        }

        async function checkActualTables() {
            document.getElementById('tableResults').innerHTML = '';
            
            try {
                addResult('tableResults', 'info', 'ğŸ” æª¢æŸ¥å¯¦éš›çš„è¡¨...', 'æ­£åœ¨æª¢æŸ¥è³‡æ–™åº«ä¸­çš„è¡¨...');
                
                // å˜—è©¦æŸ¥è©¢å¯èƒ½çš„è¡¨å
                const possibleTables = ['lost_items', 'éºå¤±ç‰©è³‡æ–™è¡¨', 'lost_item', 'å¤±ç‰©è¡¨'];
                const existingTables = [];
                
                for (const tableName of possibleTables) {
                    try {
                        const { data, error } = await supabase
                            .from(tableName)
                            .select('*')
                            .limit(1);
                        
                        if (!error) {
                            existingTables.push({
                                name: tableName,
                                data: data,
                                columns: data && data.length > 0 ? Object.keys(data[0]) : []
                            });
                        }
                    } catch (err) {
                        // å¿½ç•¥éŒ¯èª¤ï¼Œç¹¼çºŒæª¢æŸ¥ä¸‹ä¸€å€‹è¡¨
                    }
                }
                
                if (existingTables.length === 0) {
                    addResult('tableResults', 'error', 'âŒ æ‰¾ä¸åˆ°ä»»ä½•è¡¨', 'æ²’æœ‰æ‰¾åˆ°ä»»ä½•ç›¸é—œçš„è¡¨ã€‚å¯èƒ½éœ€è¦å‰µå»ºæ–°è¡¨ã€‚');
                    document.getElementById('fixOptions').style.display = 'block';
                    return;
                }
                
                // é¡¯ç¤ºæ‰¾åˆ°çš„è¡¨
                existingTables.forEach(table => {
                    const columnInfo = table.columns.length > 0 ? 
                        `<br>æ¬„ä½: ${table.columns.join(', ')}` : 
                        '<br>è¡¨ç‚ºç©ºï¼Œç„¡æ³•æª¢æ¸¬æ¬„ä½';
                    
                    addResult('tableResults', 'success', 
                        `âœ… æ‰¾åˆ°è¡¨: ${table.name}`, 
                        `è¨˜éŒ„æ•¸: ${table.data.length}${columnInfo}`);
                });
                
                // å¦‚æœæ‰¾åˆ°ä¸­æ–‡è¡¨åï¼Œé¡¯ç¤ºä¿®å¾©é¸é …
                const hasChineseTable = existingTables.some(t => t.name === 'éºå¤±ç‰©è³‡æ–™è¡¨');
                const hasEnglishTable = existingTables.some(t => t.name === 'lost_items');
                
                if (hasChineseTable && !hasEnglishTable) {
                    addResult('tableResults', 'warning', 'âš ï¸ ç™¼ç¾å•é¡Œ', 
                        'æ‰¾åˆ°ä¸­æ–‡è¡¨å "éºå¤±ç‰©è³‡æ–™è¡¨"ï¼Œä½†ç¨‹å¼ç¢¼æœŸæœ›è‹±æ–‡è¡¨å "lost_items"');
                    document.getElementById('fixOptions').style.display = 'block';
                } else if (hasEnglishTable) {
                    addResult('tableResults', 'success', 'âœ… è¡¨åç¨±æ­£ç¢º', 
                        'æ‰¾åˆ°æœŸæœ›çš„ "lost_items" è¡¨');
                    document.getElementById('testSection').style.display = 'block';
                }
                
            } catch (err) {
                addResult('tableResults', 'error', 'âŒ æª¢æŸ¥éç¨‹ç™¼ç”ŸéŒ¯èª¤', `éŒ¯èª¤: ${err.message}`);
            }
        }

        function showCreateEnglishTable() {
            const sql = `-- æ–¹æ¡ˆ 1: å‰µå»ºè‹±æ–‡è¡¨åå’Œæ¬„ä½çš„æ–°è¡¨
-- é€™æ˜¯æ¨è–¦æ–¹æ¡ˆï¼Œç¬¦åˆç¨‹å¼ç¢¼æœŸæœ›

-- å‰µå»º lost_items è¡¨
CREATE TABLE IF NOT EXISTS lost_items (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    image_url TEXT,
    image_data TEXT,
    found_location VARCHAR(50) NOT NULL DEFAULT 'æœªçŸ¥',
    found_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    story TEXT,
    finder_name VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- å¦‚æœæ‚¨å·²æœ‰ä¸­æ–‡è¡¨ "éºå¤±ç‰©è³‡æ–™è¡¨" çš„è³‡æ–™ï¼Œå¯ä»¥å°‡è³‡æ–™é·ç§»éä¾†
-- INSERT INTO lost_items (name, found_location, found_time)
-- SELECT "å¤±ç‰©åç¨±", "ç™¼ç¾åœ°é»", "ç™¼ç¾æ™‚é–“" FROM "éºå¤±ç‰©è³‡æ–™è¡¨";

-- å‰µå»º returned_items è¡¨
CREATE TABLE IF NOT EXISTS returned_items (
    id SERIAL PRIMARY KEY,
    original_lost_item_id INTEGER,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    image_url TEXT,
    image_data TEXT,
    found_location VARCHAR(50) NOT NULL,
    found_time TIMESTAMP WITH TIME ZONE,
    story TEXT,
    finder_name VARCHAR(50),
    claimer_name VARCHAR(50),
    claim_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    returned_by VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    notes TEXT
);

-- ç¦ç”¨ RLS
ALTER TABLE lost_items DISABLE ROW LEVEL SECURITY;
ALTER TABLE returned_items DISABLE ROW LEVEL SECURITY;

-- é‡æ–°æ•´ç† schema cache
NOTIFY pgrst, 'reload schema';`;

            document.getElementById('sqlCommand').textContent = sql;
            document.getElementById('fixSolution').style.display = 'block';
            document.getElementById('testSection').style.display = 'block';
        }

        function showUpdateCodeForChinese() {
            const code = `// æ–¹æ¡ˆ 2: ä¿®æ”¹ç¨‹å¼ç¢¼ä»¥é©æ‡‰ä¸­æ–‡è¡¨å
// éœ€è¦ä¿®æ”¹ script.js ä¸­çš„æ‰€æœ‰è³‡æ–™åº«æ“ä½œ

// åœ¨ script.js ä¸­æ‰¾åˆ°æ‰€æœ‰ .from('lost_items') ä¸¦æ›¿æ›ç‚º .from('éºå¤±ç‰©è³‡æ–™è¡¨')
// åŒæ™‚éœ€è¦ä¿®æ”¹æ¬„ä½åç¨±å°æ‡‰ï¼š

const chineseFieldMapping = {
    name: 'å¤±ç‰©åç¨±',
    description: 'ç‰©å“æè¿°', 
    found_location: 'ç™¼ç¾åœ°é»',
    story: 'å¤±ç‰©æ•…äº‹',
    finder_name: 'æ‹¾å¾—è€…',
    found_time: 'ç™¼ç¾æ™‚é–“',
    image_data: 'ç…§ç‰‡è³‡æ–™',
    image_url: 'ç…§ç‰‡ç¶²å€',
    created_at: 'å»ºç«‹æ™‚é–“'
};

// ä¿®æ”¹æ’å…¥è³‡æ–™çš„ç¯„ä¾‹ï¼š
const itemData = {
    'å¤±ç‰©åç¨±': itemName,
    'ç‰©å“æè¿°': description,
    'ç™¼ç¾åœ°é»': foundLocation,
    'å¤±ç‰©æ•…äº‹': story,
    'æ‹¾å¾—è€…': finderName,
    'ç™¼ç¾æ™‚é–“': new Date().toISOString()
};

const { data, error } = await supabase
    .from('éºå¤±ç‰©è³‡æ–™è¡¨')
    .insert([itemData])
    .select();

// æ³¨æ„ï¼šé€™å€‹æ–¹æ¡ˆéœ€è¦å¤§é‡ä¿®æ”¹ç¨‹å¼ç¢¼ï¼Œä¸æ¨è–¦`;

            document.getElementById('sqlCommand').textContent = code;
            document.getElementById('fixSolution').style.display = 'block';
        }

        async function testWithCorrectTable() {
            document.getElementById('testResults').innerHTML = '';
            
            try {
                addResult('testResults', 'info', 'ğŸ§ª æ¸¬è©¦ä¿®å¾©å¾Œçš„åŠŸèƒ½...', 'æ­£åœ¨æ¸¬è©¦ lost_items è¡¨...');
                
                // æ¸¬è©¦åŸºæœ¬æ’å…¥
                const testData = {
                    name: 'æ¸¬è©¦å¤±ç‰©',
                    found_location: 'æ¸¬è©¦åœ°é»',
                    story: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦æ•…äº‹',
                    found_time: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('lost_items')
                    .insert([testData])
                    .select();
                
                if (error) {
                    addResult('testResults', 'error', 'âŒ æ¸¬è©¦å¤±æ•—', 
                        `éŒ¯èª¤: ${error.message}<br>éŒ¯èª¤ä»£ç¢¼: ${error.code}`);
                    return;
                }
                
                addResult('testResults', 'success', 'âœ… æ¸¬è©¦æˆåŠŸï¼', 
                    `æˆåŠŸæ’å…¥æ¸¬è©¦è³‡æ–™ï¼ŒID: ${data[0].id}`);
                
                // æ¸¬è©¦æŸ¥è©¢
                const { data: queryData, error: queryError } = await supabase
                    .from('lost_items')
                    .select('*')
                    .eq('id', data[0].id)
                    .single();
                
                if (queryError) {
                    addResult('testResults', 'warning', 'âš ï¸ æŸ¥è©¢æ¸¬è©¦å¤±æ•—', 
                        `éŒ¯èª¤: ${queryError.message}`);
                } else {
                    addResult('testResults', 'success', 'âœ… æŸ¥è©¢æ¸¬è©¦æˆåŠŸ', 
                        `æŸ¥è©¢çµæœ: ${JSON.stringify(queryData, null, 2)}`);
                }
                
                // æ¸…ç†æ¸¬è©¦è³‡æ–™
                await supabase.from('lost_items').delete().eq('id', data[0].id);
                addResult('testResults', 'info', 'ğŸ§¹ æ¸¬è©¦è³‡æ–™å·²æ¸…ç†', '');
                
                addResult('testResults', 'success', 'ğŸ‰ ä¿®å¾©å®Œæˆï¼', 
                    'ç¾åœ¨æ‚¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ä¸Šå‚³åŠŸèƒ½äº†ï¼');
                
            } catch (err) {
                addResult('testResults', 'error', 'âŒ æ¸¬è©¦éç¨‹ç™¼ç”ŸéŒ¯èª¤', 
                    `éŒ¯èª¤: ${err.message}`);
            }
        }

        function copySQL() {
            const content = document.getElementById('sqlCommand').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²è¤‡è£½ï¼';
                btn.style.background = '#4CAF50';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#2196F3';
                }, 2000);
            });
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', function() {
            setTimeout(checkActualTables, 500);
        });
    </script>
</body>
</html>
