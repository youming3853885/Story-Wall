<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª¿è©¦ç¢ºèªå§“åæŒ‰éˆ•</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 2rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #F44336; }
        .warning { border-left: 4px solid #FF9800; }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #45a049; }
        
        .log {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .log .success { color: #4CAF50; }
        .log .error { color: #F44336; }
        .log .warning { color: #FF9800; }
        .log .info { color: #2196F3; }
        
        input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            margin: 0.5rem 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ èª¿è©¦ç¢ºèªå§“åæŒ‰éˆ•</h1>
    
    <div class="test-section">
        <h3>ğŸ¯ å•é¡Œè¨ºæ–·</h3>
        <p>æ¸¬è©¦ã€Œç¢ºèªå§“åã€æŒ‰éˆ•çš„å„ç¨®å¯èƒ½å•é¡Œï¼š</p>
        <button onclick="runDiagnostics()">ğŸš€ é–‹å§‹è¨ºæ–·</button>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª æ¨¡æ“¬æ¸¬è©¦</h3>
        <p>æ¨¡æ“¬å®Œæ•´çš„æ‰¾åˆ°ä¸»äººæµç¨‹ï¼š</p>
        
        <!-- æ¨¡æ“¬è¼¸å…¥å€åŸŸ -->
        <div style="margin: 1rem 0;">
            <label>æ¸¬è©¦å§“åè¼¸å…¥ï¼š</label>
            <input type="text" id="testOwnerNameInput" placeholder="è¼¸å…¥æ¸¬è©¦å§“å" onkeypress="if(event.key==='Enter') testConfirmOwnerName()">
            <button onclick="testConfirmOwnerName()" class="owner-btn primary">
                âœ… æ¸¬è©¦ç¢ºèªå§“å
            </button>
        </div>
        
        <!-- æ¨¡æ“¬ç¬¬äºŒå€‹å½ˆçª— -->
        <div id="testConfirmArea" style="display: none; background: #e8f5e8; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
            <h4>ğŸ“‹ ç¢ºèªè³‡è¨Š</h4>
            <div id="testConfirmInfo"></div>
            <button onclick="testFinalizeOwnerFound()" class="owner-btn primary confirm">
                ğŸ‰ æ¸¬è©¦æœ€çµ‚ç¢ºèª
            </button>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ è¨ºæ–·æ—¥èªŒ</h3>
        <div id="log" class="log">æº–å‚™é–‹å§‹è¨ºæ–·...\n</div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <script src="config.js"></script>
    <script src="script.js"></script>
    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function runDiagnostics() {
            log('ğŸ” é–‹å§‹è¨ºæ–·ç¢ºèªå§“åæŒ‰éˆ•å•é¡Œ...', 'info');
            
            // 1. æª¢æŸ¥å‡½æ•¸æ˜¯å¦å­˜åœ¨
            log('1ï¸âƒ£ æª¢æŸ¥å¿…è¦å‡½æ•¸æ˜¯å¦å­˜åœ¨...', 'info');
            
            const functions = [
                'confirmOwnerName',
                'showOwnerInputModal', 
                'hideOwnerInputModal',
                'showOwnerConfirmModal',
                'hideOwnerConfirmModal',
                'finalizeOwnerFound'
            ];
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    log(`âœ… ${funcName} å‡½æ•¸å­˜åœ¨`, 'success');
                } else {
                    log(`âŒ ${funcName} å‡½æ•¸ä¸å­˜åœ¨æˆ–ä¸å¯è¨ªå•`, 'error');
                }
            });
            
            // 2. æª¢æŸ¥å…¨å±€è®Šæ•¸
            log('2ï¸âƒ£ æª¢æŸ¥å…¨å±€è®Šæ•¸...', 'info');
            
            const variables = ['currentFoundItem', 'currentOwnerName', 'supabase'];
            variables.forEach(varName => {
                if (typeof window[varName] !== 'undefined') {
                    log(`âœ… ${varName} è®Šæ•¸å­˜åœ¨: ${typeof window[varName]}`, 'success');
                } else {
                    log(`âŒ ${varName} è®Šæ•¸ä¸å­˜åœ¨`, 'error');
                }
            });
            
            // 3. æª¢æŸ¥ DOM å…ƒç´ 
            log('3ï¸âƒ£ æª¢æŸ¥å¿…è¦çš„ DOM å…ƒç´ ...', 'info');
            
            const elements = [
                'ownerInputModal',
                'ownerNameInput', 
                'confirmOwnerBtn',
                'ownerConfirmModal',
                'foundItemPreview',
                'confirmInfo'
            ];
            
            elements.forEach(elemId => {
                const elem = document.getElementById(elemId);
                if (elem) {
                    log(`âœ… å…ƒç´  #${elemId} å­˜åœ¨`, 'success');
                } else {
                    log(`âŒ å…ƒç´  #${elemId} ä¸å­˜åœ¨`, 'error');
                }
            });
            
            // 4. æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶ç¶å®š
            log('4ï¸âƒ£ æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶ç¶å®š...', 'info');
            
            const confirmBtn = document.getElementById('confirmOwnerBtn');
            if (confirmBtn) {
                const onclickAttr = confirmBtn.getAttribute('onclick');
                log(`æŒ‰éˆ• onclick å±¬æ€§: ${onclickAttr}`, 'info');
                
                if (onclickAttr && onclickAttr.includes('confirmOwnerName')) {
                    log('âœ… æŒ‰éˆ• onclick å±¬æ€§æ­£ç¢ºè¨­ç½®', 'success');
                } else {
                    log('âŒ æŒ‰éˆ• onclick å±¬æ€§è¨­ç½®ç•°å¸¸', 'error');
                }
            }
            
            // 5. æ¸¬è©¦ JavaScript éŒ¯èª¤
            log('5ï¸âƒ£ æª¢æŸ¥æ˜¯å¦æœ‰ JavaScript éŒ¯èª¤...', 'info');
            
            window.addEventListener('error', function(e) {
                log(`âŒ JavaScript éŒ¯èª¤: ${e.message} (${e.filename}:${e.lineno})`, 'error');
            });
            
            log('âœ… è¨ºæ–·å®Œæˆï¼è«‹æŸ¥çœ‹ä¸Šè¿°çµæœæ‰¾å‡ºå•é¡Œæ‰€åœ¨ã€‚', 'success');
        }

        // æ¸¬è©¦å‡½æ•¸
        function testConfirmOwnerName() {
            const testName = document.getElementById('testOwnerNameInput').value.trim();
            log(`ğŸ§ª æ¸¬è©¦ç¢ºèªå§“åå‡½æ•¸ï¼Œè¼¸å…¥: "${testName}"`, 'info');
            
            if (!testName) {
                log('âŒ è«‹è¼¸å…¥æ¸¬è©¦å§“å', 'error');
                alert('è«‹è¼¸å…¥æ¸¬è©¦å§“å');
                return;
            }
            
            if (testName.length < 2) {
                log('âŒ å§“åé•·åº¦ä¸è¶³', 'error');
                alert('è«‹è¼¸å…¥å®Œæ•´çš„å§“åï¼ˆè‡³å°‘2å€‹å­—ï¼‰');
                return;
            }
            
            log('âœ… é©—è­‰é€šéï¼Œé¡¯ç¤ºç¢ºèªå€åŸŸ', 'success');
            
            // é¡¯ç¤ºæ¸¬è©¦ç¢ºèªå€åŸŸ
            document.getElementById('testConfirmInfo').innerHTML = `
                <div><strong>æ¸¬è©¦å§“åï¼š</strong> ${testName}</div>
                <div><strong>æ¸¬è©¦æ™‚é–“ï¼š</strong> ${new Date().toLocaleString('zh-TW')}</div>
            `;
            
            document.getElementById('testConfirmArea').style.display = 'block';
            
            log('ğŸ¯ æ¨¡æ“¬ç¬¬ä¸€æ­¥å®Œæˆï¼Œç¾åœ¨å¯ä»¥æ¸¬è©¦æœ€çµ‚ç¢ºèª', 'success');
        }

        function testFinalizeOwnerFound() {
            log('ğŸ‰ æ¸¬è©¦æœ€çµ‚ç¢ºèªå‡½æ•¸', 'info');
            alert('æ¸¬è©¦æˆåŠŸï¼å¦‚æœçœ‹åˆ°é€™å€‹è¨Šæ¯ï¼Œèªªæ˜å‡½æ•¸èª¿ç”¨æ­£å¸¸ã€‚');
            log('âœ… æœ€çµ‚ç¢ºèªæ¸¬è©¦å®Œæˆ', 'success');
            
            // éš±è—æ¸¬è©¦å€åŸŸ
            document.getElementById('testConfirmArea').style.display = 'none';
            document.getElementById('testOwnerNameInput').value = '';
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¨ºæ–·
        window.addEventListener('load', function() {
            log('ğŸ”§ ç¢ºèªå§“åæŒ‰éˆ•èª¿è©¦å·¥å…·å·²è¼‰å…¥', 'info');
            setTimeout(runDiagnostics, 500);
        });

        // ç›£è½é»æ“Šäº‹ä»¶ä¾†èª¿è©¦
        document.addEventListener('click', function(e) {
            if (e.target.id === 'confirmOwnerBtn') {
                log('ğŸ‘† æª¢æ¸¬åˆ°ç¢ºèªå§“åæŒ‰éˆ•è¢«é»æ“Š', 'info');
            }
        });

        // ç›£è½éŒ¯èª¤
        window.addEventListener('error', function(e) {
            log(`âŒ å…¨å±€éŒ¯èª¤: ${e.message}`, 'error');
        });
    </script>
</body>
</html>
