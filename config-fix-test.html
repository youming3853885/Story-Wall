<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ç½®ä¿®å¾©æ¸¬è©¦</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 2rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #F44336; }
        .warning { border-left: 4px solid #FF9800; }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #45a049; }
        
        .log {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .log .success { color: #4CAF50; }
        .log .error { color: #F44336; }
        .log .warning { color: #FF9800; }
    </style>
</head>
<body>
    <h1>ğŸ”§ é…ç½®ä¿®å¾©æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h3>ğŸ“‹ æ¸¬è©¦æ­¥é©Ÿ</h3>
        <p>é€™å€‹å·¥å…·æœƒé€æ­¥æ¸¬è©¦ä¿®å¾©çš„é…ç½®è¼‰å…¥å•é¡Œï¼š</p>
        <ol>
            <li>æª¢æŸ¥ Supabase CDN è¼‰å…¥</li>
            <li>æ¸¬è©¦é…ç½®æ–‡ä»¶è¼‰å…¥</li>
            <li>é©—è­‰å‚™ç”¨é…ç½®æ©Ÿåˆ¶</li>
            <li>æ¸¬è©¦ Supabase å®¢æˆ¶ç«¯åˆå§‹åŒ–</li>
            <li>æª¢æŸ¥è³‡æ–™åº«é€£ç·š</li>
        </ol>
        <button onclick="runFullTest()">ğŸš€ åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
    </div>

    <div class="test-section">
        <h3>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h3>
        <div id="log" class="log">æº–å‚™é–‹å§‹æ¸¬è©¦...\n</div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <div id="results"></div>

    <script src="config.js"></script>
    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function addResult(type, title, content) {
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<h4>${title}</h4>${content}`;
            document.getElementById('results').appendChild(div);
        }

        async function runFullTest() {
            document.getElementById('results').innerHTML = '';
            log('ğŸš€ é–‹å§‹åŸ·è¡Œå®Œæ•´é…ç½®æ¸¬è©¦', 'info');
            
            // æ¸¬è©¦ 1: Supabase CDN
            log('ğŸ“¦ æ¸¬è©¦ 1: æª¢æŸ¥ Supabase CDN è¼‰å…¥');
            if (typeof window.supabase === 'undefined') {
                log('âŒ Supabase CDN æœªè¼‰å…¥', 'error');
                addResult('error', 'âŒ æ¸¬è©¦å¤±æ•—', 'Supabase CDN æœªæ­£ç¢ºè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                return;
            }
            log('âœ… Supabase CDN è¼‰å…¥æˆåŠŸ', 'success');
            
            // æ¸¬è©¦ 2: é…ç½®æ–‡ä»¶è¼‰å…¥
            log('âš™ï¸ æ¸¬è©¦ 2: æª¢æŸ¥é…ç½®æ–‡ä»¶è¼‰å…¥');
            if (typeof window.LostItemsConfig === 'undefined') {
                log('âš ï¸ ä¸»é…ç½®æ–‡ä»¶æœªè¼‰å…¥ï¼Œæ¸¬è©¦å‚™ç”¨æ©Ÿåˆ¶', 'warning');
                
                // æ¨¡æ“¬å‚™ç”¨é…ç½®
                const fallbackConfig = {
                    supabase: {
                        url: 'https://oytgyizrtuqyxvxtgrlv.supabase.co',
                        anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dGd5aXpydHVxeXh2eHRncmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUwNjgsImV4cCI6MjA3MTE1MTA2OH0.OiHI8KP-p0OOKo6XvPOARsz0pYqWBEMowJbL0wOzrQs'
                    },
                    app: {
                        adminPassword: '1234'
                    }
                };
                
                window.LostItemsConfig = { config: fallbackConfig };
                log('âœ… å‚™ç”¨é…ç½®è¼‰å…¥æˆåŠŸ', 'success');
            } else {
                log('âœ… ä¸»é…ç½®æ–‡ä»¶è¼‰å…¥æˆåŠŸ', 'success');
            }
            
            // æ¸¬è©¦ 3: é…ç½®å…§å®¹é©—è­‰
            log('ğŸ” æ¸¬è©¦ 3: é©—è­‰é…ç½®å…§å®¹');
            const config = window.LostItemsConfig.config;
            if (!config.supabase || !config.supabase.url || !config.supabase.anonKey) {
                log('âŒ é…ç½®å…§å®¹ä¸å®Œæ•´', 'error');
                addResult('error', 'âŒ é…ç½®éŒ¯èª¤', 'é…ç½®æ–‡ä»¶ä¸­ç¼ºå°‘å¿…è¦çš„ Supabase åƒæ•¸');
                return;
            }
            log('âœ… é…ç½®å…§å®¹é©—è­‰é€šé', 'success');
            log(`   URL: ${config.supabase.url.substring(0, 30)}...`);
            log(`   API Key: ${config.supabase.anonKey.substring(0, 20)}...`);
            
            // æ¸¬è©¦ 4: Supabase å®¢æˆ¶ç«¯åˆå§‹åŒ–
            log('ğŸ”— æ¸¬è©¦ 4: åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯');
            let supabase;
            try {
                supabase = window.supabase.createClient(config.supabase.url, config.supabase.anonKey);
                log('âœ… Supabase å®¢æˆ¶ç«¯å‰µå»ºæˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ Supabase å®¢æˆ¶ç«¯å‰µå»ºå¤±æ•—: ${error.message}`, 'error');
                addResult('error', 'âŒ å®¢æˆ¶ç«¯åˆå§‹åŒ–å¤±æ•—', error.message);
                return;
            }
            
            // æ¸¬è©¦ 5: è³‡æ–™åº«é€£ç·šæ¸¬è©¦
            log('ğŸ“¡ æ¸¬è©¦ 5: æª¢æŸ¥è³‡æ–™åº«é€£ç·š');
            try {
                const { data, error } = await supabase
                    .from('lost_items')
                    .select('count(*)', { count: 'exact', head: true });

                if (error) {
                    if (error.code === 'PGRST116') {
                        log('âš ï¸ lost_items è¡¨ä¸å­˜åœ¨ï¼ˆé€™æ˜¯æ­£å¸¸çš„ï¼‰', 'warning');
                        addResult('warning', 'âš ï¸ è¡¨æ ¼ä¸å­˜åœ¨', 'lost_items è¡¨å°šæœªå‰µå»ºï¼Œä½†é€£ç·šæ­£å¸¸');
                    } else {
                        log(`âš ï¸ è³‡æ–™åº«æŸ¥è©¢ç•°å¸¸: ${error.message}`, 'warning');
                        log('é€™å¯èƒ½æ˜¯ RLS è¨­ç½®æˆ–æ¬Šé™å•é¡Œï¼Œä½†ä¸å½±éŸ¿åŸºæœ¬åŠŸèƒ½', 'info');
                        addResult('warning', 'âš ï¸ è³‡æ–™åº«æ¬Šé™å•é¡Œ', `${error.message}<br>å»ºè­°æª¢æŸ¥ RLS è¨­ç½®æˆ–è¡¨æ ¼æ¬Šé™`);
                    }
                } else {
                    log('âœ… è³‡æ–™åº«é€£ç·šå’ŒæŸ¥è©¢æˆåŠŸ', 'success');
                    addResult('success', 'âœ… è³‡æ–™åº«é€£ç·šæ­£å¸¸', 'å¯ä»¥æ­£å¸¸è¨ªå• lost_items è¡¨');
                }
            } catch (dbError) {
                log(`âŒ è³‡æ–™åº«é€£ç·šæ¸¬è©¦ç•°å¸¸: ${dbError.message}`, 'error');
                addResult('error', 'âŒ è³‡æ–™åº«é€£ç·šå¤±æ•—', dbError.message);
                return;
            }
            
            // ç¸½çµ
            log('ğŸ‰ æ¸¬è©¦å®Œæˆï¼', 'success');
            addResult('success', 'âœ… ä¿®å¾©æˆåŠŸ', `
                æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½å·²æ­£å¸¸é‹ä½œï¼š<br>
                â€¢ Supabase CDN è¼‰å…¥æ­£å¸¸<br>
                â€¢ é…ç½®ç³»çµ±é‹ä½œæ­£å¸¸ï¼ˆåŒ…æ‹¬å‚™ç”¨æ©Ÿåˆ¶ï¼‰<br>
                â€¢ è³‡æ–™åº«å®¢æˆ¶ç«¯åˆå§‹åŒ–æˆåŠŸ<br>
                â€¢ åŸºæœ¬é€£ç·šåŠŸèƒ½æ­£å¸¸<br><br>
                <strong>ç¾åœ¨æ‚¨å¯ä»¥æ­£å¸¸ä½¿ç”¨å¤±ç‰©æ•…äº‹ç‰†äº†ï¼</strong>
            `);
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œæ¸¬è©¦
        window.addEventListener('load', function() {
            setTimeout(runFullTest, 1000);
        });
    </script>
</body>
</html>
