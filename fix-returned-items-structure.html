<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¾© returned_items è¡¨çµæ§‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 2rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #F44336; }
        .warning { border-left: 4px solid #FF9800; }
        .info { border-left: 4px solid #2196F3; }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .log {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .log .success { color: #4CAF50; }
        .log .error { color: #F44336; }
        .log .warning { color: #FF9800; }
        .log .info { color: #2196F3; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }
        th { background: #f5f5f5; }
        .missing { background: #ffebee; color: #c62828; }
        .exists { background: #e8f5e8; color: #2e7d32; }
        
        .sql-code {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ä¿®å¾© returned_items è¡¨çµæ§‹</h1>
    
    <div class="section info">
        <h3>ğŸ“‹ ä¿®å¾©ç›®æ¨™</h3>
        <p>æª¢æŸ¥ä¸¦ä¿®å¾© <code>returned_items</code> è¡¨çš„çµæ§‹å•é¡Œï¼š</p>
        <ul>
            <li>ç¢ºä¿æ‰€æœ‰å¿…è¦æ¬„ä½å­˜åœ¨</li>
            <li>ä¿®å¾©æ¬„ä½åç¨±ä¸ä¸€è‡´å•é¡Œ</li>
            <li>ç¦ç”¨ RLS ä»¥ä¾¿æ­£å¸¸æ“ä½œ</li>
            <li>åˆ·æ–° schema cache</li>
        </ul>
        <button onclick="checkTableStructure()">ğŸ” æª¢æŸ¥è¡¨æ ¼çµæ§‹</button>
        <button onclick="executeFixSQL()">ğŸ› ï¸ åŸ·è¡Œä¿®å¾© SQL</button>
        <button onclick="testInsertion()">ğŸ§ª æ¸¬è©¦æ’å…¥è³‡æ–™</button>
    </div>

    <div class="section">
        <h3>ğŸ“Š ç•¶å‰è¡¨æ ¼çµæ§‹</h3>
        <div id="tableStructure">é»æ“Šã€Œæª¢æŸ¥è¡¨æ ¼çµæ§‹ã€æŸ¥çœ‹ç•¶å‰ç‹€æ…‹</div>
    </div>

    <div class="section">
        <h3>ğŸ› ï¸ ä¿®å¾© SQL èªå¥</h3>
        <p>å¦‚æœè‡ªå‹•ä¿®å¾©å¤±æ•—ï¼Œè«‹æ‰‹å‹•åœ¨ Supabase SQL Editor ä¸­åŸ·è¡Œä»¥ä¸‹ SQLï¼š</p>
        <div class="sql-code" id="fixSQL">-- ä¿®å¾© returned_items è¡¨çµæ§‹

-- ç¢ºä¿è¡¨æ ¼å­˜åœ¨
CREATE TABLE IF NOT EXISTS returned_items (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ·»åŠ ç¼ºå°‘çš„æ¬„ä½
ALTER TABLE returned_items 
ADD COLUMN IF NOT EXISTS original_lost_item_id INTEGER,
ADD COLUMN IF NOT EXISTS description TEXT,
ADD COLUMN IF NOT EXISTS image_url TEXT,
ADD COLUMN IF NOT EXISTS image_data TEXT,
ADD COLUMN IF NOT EXISTS found_location VARCHAR(50),
ADD COLUMN IF NOT EXISTS found_time TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS story TEXT,
ADD COLUMN IF NOT EXISTS finder_name VARCHAR(50),
ADD COLUMN IF NOT EXISTS claimer_name VARCHAR(50),
ADD COLUMN IF NOT EXISTS claim_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
ADD COLUMN IF NOT EXISTS returned_by VARCHAR(50),
ADD COLUMN IF NOT EXISTS notes TEXT;

-- ç¦ç”¨ RLS
ALTER TABLE returned_items DISABLE ROW LEVEL SECURITY;

-- è¨­ç½®æ¬Šé™
GRANT ALL ON returned_items TO anon;
GRANT ALL ON returned_items TO authenticated;
GRANT USAGE, SELECT ON SEQUENCE returned_items_id_seq TO anon;
GRANT USAGE, SELECT ON SEQUENCE returned_items_id_seq TO authenticated;

-- åˆ·æ–° schema
NOTIFY pgrst, 'reload schema';</div>
    </div>

    <div class="section">
        <h3>ğŸ“ æ“ä½œæ—¥èªŒ</h3>
        <div id="log" class="log">æº–å‚™é–‹å§‹æª¢æŸ¥...\n</div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <script src="config.js"></script>
    <script>
        // åˆå§‹åŒ– Supabase
        let supabase;
        
        if (typeof window.LostItemsConfig !== 'undefined') {
            const config = window.LostItemsConfig.config;
            supabase = window.supabase.createClient(config.supabase.url, config.supabase.anonKey);
        } else {
            const supabaseUrl = 'https://oytgyizrtuqyxvxtgrlv.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dGd5aXpydHVxeXh2eHRncmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUwNjgsImV4cCI6MjA3MTE1MTA2OH0.OiHI8KP-p0OOKo6XvPOARsz0pYqWBEMowJbL0wOzrQs';
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // å¿…è¦çš„æ¬„ä½åˆ—è¡¨
        const requiredColumns = [
            'id',
            'original_lost_item_id',
            'name',
            'description',
            'image_url',
            'image_data',
            'found_location',
            'found_time',
            'story',
            'finder_name',
            'claimer_name',
            'claim_time',
            'returned_by',
            'notes',
            'created_at'
        ];

        async function checkTableStructure() {
            log('ğŸ” æª¢æŸ¥ returned_items è¡¨æ ¼çµæ§‹...', 'info');
            
            try {
                // å˜—è©¦æŸ¥è©¢è¡¨æ ¼ä»¥æª¢æŸ¥æ˜¯å¦å­˜åœ¨
                const { data, error } = await supabase
                    .from('returned_items')
                    .select('*')
                    .limit(0);

                if (error) {
                    if (error.code === 'PGRST116') {
                        log('âŒ returned_items è¡¨ä¸å­˜åœ¨', 'error');
                        showTableStatus('âŒ è¡¨æ ¼ä¸å­˜åœ¨', 'error');
                        return;
                    } else {
                        log(`âš ï¸ æŸ¥è©¢è¡¨æ ¼æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'warning');
                    }
                }

                log('âœ… returned_items è¡¨å­˜åœ¨', 'success');

                // å˜—è©¦ç²å–è¡¨æ ¼çµæ§‹ï¼ˆé€šéå˜—è©¦æ’å…¥ç©ºè³‡æ–™ä¾†è§¸ç™¼æ¬„ä½éŒ¯èª¤ï¼‰
                const testData = requiredColumns.reduce((obj, col) => {
                    if (col !== 'id' && col !== 'created_at') {
                        obj[col] = null;
                    }
                    return obj;
                }, {});

                const { error: insertError } = await supabase
                    .from('returned_items')
                    .insert([testData]);

                if (insertError) {
                    const missingColumns = [];
                    const errorMessage = insertError.message;
                    
                    // åˆ†æéŒ¯èª¤è¨Šæ¯æ‰¾å‡ºç¼ºå¤±çš„æ¬„ä½
                    requiredColumns.forEach(col => {
                        if (errorMessage.includes(`'${col}'`) && errorMessage.includes('not found')) {
                            missingColumns.push(col);
                        }
                    });

                    if (missingColumns.length > 0) {
                        log(`âŒ ç¼ºå°‘ä»¥ä¸‹æ¬„ä½: ${missingColumns.join(', ')}`, 'error');
                        showTableStatus(missingColumns, 'partial');
                    } else {
                        log('âš ï¸ æ’å…¥æ¸¬è©¦å¤±æ•—ï¼Œä½†ä¸æ˜¯å› ç‚ºç¼ºå°‘æ¬„ä½', 'warning');
                        log(`éŒ¯èª¤è¨Šæ¯: ${errorMessage}`, 'info');
                        showTableStatus('âœ… æ‰€æœ‰æ¬„ä½éƒ½å­˜åœ¨', 'success');
                    }
                } else {
                    log('âœ… æ‰€æœ‰å¿…è¦æ¬„ä½éƒ½å­˜åœ¨', 'success');
                    showTableStatus('âœ… è¡¨æ ¼çµæ§‹å®Œæ•´', 'success');
                }

            } catch (err) {
                log(`âŒ æª¢æŸ¥éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${err.message}`, 'error');
                showTableStatus('âŒ æª¢æŸ¥å¤±æ•—', 'error');
            }
        }

        function showTableStatus(status, type) {
            const container = document.getElementById('tableStructure');
            
            if (Array.isArray(status)) {
                // é¡¯ç¤ºç¼ºå¤±æ¬„ä½åˆ—è¡¨
                const tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>æ¬„ä½åç¨±</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requiredColumns.map(col => {
                                const missing = status.includes(col);
                                return `
                                    <tr class="${missing ? 'missing' : 'exists'}">
                                        <td>${col}</td>
                                        <td>${missing ? 'âŒ ç¼ºå¤±' : 'âœ… å­˜åœ¨'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                container.innerHTML = tableHTML;
            } else {
                container.innerHTML = `<div class="section ${type}"><h4>${status}</h4></div>`;
            }
        }

        async function executeFixSQL() {
            log('ğŸ› ï¸ é–‹å§‹åŸ·è¡Œä¿®å¾© SQL...', 'info');
            
            try {
                // åŸ·è¡Œå¤šå€‹ SQL èªå¥ä¾†ä¿®å¾©è¡¨æ ¼
                const sqlStatements = [
                    // 1. ç¢ºä¿è¡¨æ ¼å­˜åœ¨
                    `CREATE TABLE IF NOT EXISTS returned_items (
                        id SERIAL PRIMARY KEY,
                        name VARCHAR(100) NOT NULL,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    // 2. æ·»åŠ ç¼ºå¤±çš„æ¬„ä½ï¼ˆä½¿ç”¨ IF NOT EXISTSï¼‰
                    `ALTER TABLE returned_items 
                     ADD COLUMN IF NOT EXISTS original_lost_item_id INTEGER,
                     ADD COLUMN IF NOT EXISTS description TEXT,
                     ADD COLUMN IF NOT EXISTS image_url TEXT,
                     ADD COLUMN IF NOT EXISTS image_data TEXT,
                     ADD COLUMN IF NOT EXISTS found_location VARCHAR(50),
                     ADD COLUMN IF NOT EXISTS found_time TIMESTAMP WITH TIME ZONE,
                     ADD COLUMN IF NOT EXISTS story TEXT,
                     ADD COLUMN IF NOT EXISTS finder_name VARCHAR(50),
                     ADD COLUMN IF NOT EXISTS claimer_name VARCHAR(50),
                     ADD COLUMN IF NOT EXISTS claim_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                     ADD COLUMN IF NOT EXISTS returned_by VARCHAR(50),
                     ADD COLUMN IF NOT EXISTS notes TEXT`
                ];

                for (const sql of sqlStatements) {
                    const { error } = await supabase.rpc('exec_sql', { sql_query: sql });
                    if (error) {
                        log(`âš ï¸ SQL åŸ·è¡Œè­¦å‘Š: ${error.message}`, 'warning');
                    } else {
                        log('âœ… SQL èªå¥åŸ·è¡ŒæˆåŠŸ', 'success');
                    }
                }

                log('ğŸ‰ è¡¨æ ¼ä¿®å¾©å®Œæˆï¼', 'success');
                
                // é‡æ–°æª¢æŸ¥çµæ§‹
                setTimeout(checkTableStructure, 1000);

            } catch (err) {
                log(`âŒ ä¿®å¾©éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${err.message}`, 'error');
                log('ğŸ’¡ è«‹æ‰‹å‹•åŸ·è¡Œ SQL èªå¥', 'info');
            }
        }

        async function testInsertion() {
            log('ğŸ§ª æ¸¬è©¦æ’å…¥ returned_items è³‡æ–™...', 'info');
            
            try {
                const testData = {
                    original_lost_item_id: 999,
                    name: 'æ¸¬è©¦å¤±ç‰©',
                    description: 'æ¸¬è©¦æè¿°',
                    found_location: 'æ¸¬è©¦åœ°é»',
                    story: 'æ¸¬è©¦æ•…äº‹',
                    finder_name: 'æ¸¬è©¦æ‹¾å¾—è€…',
                    claimer_name: 'æ¸¬è©¦èªé ˜è€…',
                    claim_time: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('returned_items')
                    .insert([testData])
                    .select();

                if (error) {
                    log(`âŒ æ’å…¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                    if (error.message.includes('schema cache')) {
                        log('ğŸ’¡ å»ºè­°åˆ·æ–° Supabase Dashboard æˆ–ç­‰å¾…å¹¾åˆ†é˜', 'info');
                    }
                } else {
                    log('âœ… æ’å…¥æ¸¬è©¦æˆåŠŸï¼', 'success');
                    log(`æ’å…¥çš„è¨˜éŒ„ ID: ${data[0].id}`, 'info');
                    
                    // æ¸…ç†æ¸¬è©¦è³‡æ–™
                    await supabase
                        .from('returned_items')
                        .delete()
                        .eq('id', data[0].id);
                    log('ğŸ—‘ï¸ å·²æ¸…ç†æ¸¬è©¦è³‡æ–™', 'info');
                }

            } catch (err) {
                log(`âŒ æ¸¬è©¦éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${err.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', function() {
            log('ğŸ”§ returned_items è¡¨æ ¼ä¿®å¾©å·¥å…·å·²è¼‰å…¥', 'info');
            setTimeout(checkTableStructure, 500);
        });
    </script>
</body>
</html>
