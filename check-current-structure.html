<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æª¢æŸ¥ç•¶å‰è³‡æ–™åº«çµæ§‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .result {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #F44336; }
        .info { border-left: 4px solid #2196F3; }
        .warning { border-left: 4px solid #FF9800; }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 1rem 2rem; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 0.5rem 0;
            width: 100%;
        }
        button:hover { background: #45a049; }
        pre { 
            background: #f9f9f9; 
            padding: 1rem; 
            border-radius: 4px; 
            overflow-x: auto; 
            white-space: pre-wrap;
        }
        .sql-command {
            background: #263238;
            color: #eee;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            margin: 1rem 0;
            white-space: pre-wrap;
        }
        .copy-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0;
            width: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” æª¢æŸ¥ç•¶å‰è³‡æ–™åº«çµæ§‹</h1>
    
    <div class="result info">
        <button onclick="checkCurrentStructure()">æª¢æŸ¥ lost_items è¡¨çµæ§‹</button>
    </div>

    <div id="results"></div>
    
    <div class="result warning" id="sqlFix" style="display: none;">
        <h3>ğŸ“ éœ€è¦åŸ·è¡Œçš„ä¿®å¾© SQL</h3>
        <p>è«‹åœ¨ Supabase SQL Editor ä¸­åŸ·è¡Œä»¥ä¸‹ SQLï¼š</p>
        <div class="sql-command" id="sqlCommand"></div>
        <button class="copy-btn" onclick="copySQL()">ğŸ“‹ è¤‡è£½ SQL</button>
        <p><strong>åŸ·è¡Œæ­¥é©Ÿï¼š</strong></p>
        <ol>
            <li>å‰å¾€ <a href="https://supabase.com/dashboard" target="_blank">Supabase Dashboard</a></li>
            <li>é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ</li>
            <li>é»æ“Šå·¦å´ "SQL Editor"</li>
            <li>è²¼ä¸Šä¸Šé¢çš„ SQL</li>
            <li>é»æ“Š "Run" åŸ·è¡Œ</li>
        </ol>
    </div>

    <script>
        const supabaseUrl = 'https://oytgyizrtuqyxvxtgrlv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dGd5aXpydHVxeXh2eHRncmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUwNjgsImV4cCI6MjA3MTE1MTA2OH0.OiHI8KP-p0OOKo6XvPOARsz0pYqWBEMowJbL0wOzrQs';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function addResult(type, title, content) {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<h3>${title}</h3>${content}`;
            document.getElementById('results').appendChild(div);
        }

        async function checkCurrentStructure() {
            document.getElementById('results').innerHTML = '';
            
            try {
                addResult('info', 'ğŸ” æª¢æŸ¥ lost_items è¡¨...', 'æ­£åœ¨æª¢æŸ¥è¡¨çµæ§‹...');
                
                // æ–¹æ³• 1: å˜—è©¦æŸ¥è©¢è¡¨ä¸­çš„è³‡æ–™ä»¥äº†è§£çµæ§‹
                const { data: sampleData, error: sampleError } = await supabase
                    .from('lost_items')
                    .select('*')
                    .limit(1);

                if (sampleError) {
                    addResult('error', 'âŒ æŸ¥è©¢å¤±æ•—', `éŒ¯èª¤: ${sampleError.message}<br>éŒ¯èª¤ä»£ç¢¼: ${sampleError.code}`);
                    
                    if (sampleError.code === 'PGRST204') {
                        addResult('warning', 'âš ï¸ Schema Cache å•é¡Œ', 
                            'é€™å€‹éŒ¯èª¤é€šå¸¸è¡¨ç¤ºè¡¨çµæ§‹èˆ‡æ‡‰ç”¨ç¨‹å¼æœŸæœ›çš„ä¸ç¬¦ã€‚<br>' +
                            'å¯èƒ½çš„åŸå› ï¼š<br>' +
                            '1. è¡¨ç¼ºå°‘æŸäº›æ¬„ä½<br>' +
                            '2. Schema cache éœ€è¦é‡æ–°æ•´ç†<br>' +
                            '3. RLS æ”¿ç­–æœ‰å•é¡Œ');
                        
                        generateFixSQL();
                    }
                    return;
                }

                // å¦‚æœæŸ¥è©¢æˆåŠŸï¼Œé¡¯ç¤ºç•¶å‰çµæ§‹
                if (sampleData && sampleData.length > 0) {
                    const columns = Object.keys(sampleData[0]);
                    addResult('success', 'âœ… è¡¨å­˜åœ¨ä¸”æœ‰è³‡æ–™', 
                        `æ‰¾åˆ° ${sampleData.length} ç­†è³‡æ–™<br>` +
                        `ç¾æœ‰æ¬„ä½: ${columns.join(', ')}`);
                    
                    // æª¢æŸ¥æ˜¯å¦ç¼ºå°‘å¿…è¦æ¬„ä½
                    const requiredColumns = ['id', 'name', 'description', 'image_url', 'image_data', 'found_location', 'story', 'finder_name', 'found_time', 'created_at'];
                    const missingColumns = requiredColumns.filter(col => !columns.includes(col));
                    
                    if (missingColumns.length > 0) {
                        addResult('warning', 'âš ï¸ ç¼ºå°‘å¿…è¦æ¬„ä½', 
                            `ç¼ºå°‘çš„æ¬„ä½: ${missingColumns.join(', ')}`);
                        generateAddColumnsSQL(missingColumns);
                    } else {
                        addResult('success', 'âœ… è¡¨çµæ§‹å®Œæ•´', 'æ‰€æœ‰å¿…è¦æ¬„ä½éƒ½å­˜åœ¨ï¼');
                        
                        // æ¸¬è©¦æ’å…¥åŠŸèƒ½
                        await testInsert();
                    }
                } else {
                    // è¡¨å­˜åœ¨ä½†æ²’æœ‰è³‡æ–™
                    addResult('info', 'â„¹ï¸ è¡¨å­˜åœ¨ä½†ç‚ºç©º', 'è¡¨çµæ§‹å­˜åœ¨ï¼Œä½†æ²’æœ‰è³‡æ–™ã€‚');
                    
                    // å˜—è©¦æ’å…¥æ¸¬è©¦è³‡æ–™ä¾†æª¢æŸ¥çµæ§‹
                    await testInsert();
                }

            } catch (err) {
                addResult('error', 'âŒ æª¢æŸ¥éç¨‹ç™¼ç”ŸéŒ¯èª¤', `éŒ¯èª¤: ${err.message}`);
            }
        }

        async function testInsert() {
            try {
                addResult('info', 'ğŸ§ª æ¸¬è©¦æ’å…¥åŠŸèƒ½...', 'å˜—è©¦æ’å…¥æœ€åŸºæœ¬çš„æ¸¬è©¦è³‡æ–™...');
                
                // å…ˆæ¸¬è©¦æœ€åŸºæœ¬çš„è³‡æ–™
                const basicData = {
                    name: 'æ¸¬è©¦ç‰©å“',
                    found_location: 'æ¸¬è©¦åœ°é»'
                };

                const { data: basicResult, error: basicError } = await supabase
                    .from('lost_items')
                    .insert([basicData])
                    .select();

                if (basicError) {
                    addResult('error', 'âŒ åŸºæœ¬æ’å…¥å¤±æ•—', 
                        `éŒ¯èª¤: ${basicError.message}<br>éŒ¯èª¤ä»£ç¢¼: ${basicError.code}`);
                    
                    if (basicError.code === 'PGRST204') {
                        generateFixSQL();
                    }
                    return;
                }

                addResult('success', 'âœ… åŸºæœ¬æ’å…¥æˆåŠŸ', `æˆåŠŸæ’å…¥åŸºæœ¬è³‡æ–™ï¼ŒID: ${basicResult[0].id}`);
                
                // æ¸…ç†æ¸¬è©¦è³‡æ–™
                await supabase.from('lost_items').delete().eq('id', basicResult[0].id);
                
                // æ¸¬è©¦å®Œæ•´è³‡æ–™æ’å…¥
                const fullData = {
                    name: 'å®Œæ•´æ¸¬è©¦ç‰©å“',
                    description: 'æ¸¬è©¦æè¿°',
                    found_location: 'æ¸¬è©¦åœ°é»',
                    story: 'æ¸¬è©¦æ•…äº‹',
                    finder_name: 'æ¸¬è©¦å“¡',
                    image_data: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNmMGYwZjAiLz48L3N2Zz4=',
                    found_time: new Date().toISOString()
                };

                const { data: fullResult, error: fullError } = await supabase
                    .from('lost_items')
                    .insert([fullData])
                    .select();

                if (fullError) {
                    addResult('error', 'âŒ å®Œæ•´è³‡æ–™æ’å…¥å¤±æ•—', 
                        `éŒ¯èª¤: ${fullError.message}<br>éŒ¯èª¤ä»£ç¢¼: ${fullError.code}`);
                    
                    if (fullError.code === 'PGRST204') {
                        addResult('warning', 'âš ï¸ éœ€è¦æ·»åŠ æ¬„ä½', 'è¡¨çµæ§‹ä¸å®Œæ•´ï¼Œéœ€è¦æ·»åŠ ç¼ºå°‘çš„æ¬„ä½');
                        generateFixSQL();
                    }
                } else {
                    addResult('success', 'âœ… å®Œæ•´è³‡æ–™æ’å…¥æˆåŠŸ', `æˆåŠŸæ’å…¥å®Œæ•´è³‡æ–™ï¼ŒID: ${fullResult[0].id}`);
                    
                    // æ¸…ç†æ¸¬è©¦è³‡æ–™
                    await supabase.from('lost_items').delete().eq('id', fullResult[0].id);
                    
                    addResult('success', 'ğŸ‰ è³‡æ–™åº«åŠŸèƒ½å®Œå…¨æ­£å¸¸', 'æ‚¨çš„è³‡æ–™åº«çµæ§‹å’ŒåŠŸèƒ½éƒ½æ­£å¸¸ï¼Œå•é¡Œå¯èƒ½åœ¨å…¶ä»–åœ°æ–¹ã€‚');
                }

            } catch (err) {
                addResult('error', 'âŒ æ¸¬è©¦æ’å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤', `éŒ¯èª¤: ${err.message}`);
            }
        }

        function generateFixSQL() {
            const sql = `-- ä¿®å¾© lost_items è¡¨çµæ§‹
-- æ·»åŠ ç¼ºå°‘çš„æ¬„ä½ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS description TEXT;
ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS image_url TEXT;
ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS image_data TEXT;
ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS story TEXT;
ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS finder_name VARCHAR(50);
ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS found_time TIMESTAMP WITH TIME ZONE DEFAULT NOW();
ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();
ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- ç¢ºä¿åŸºæœ¬æ¬„ä½å­˜åœ¨
ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS id SERIAL PRIMARY KEY;
ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS name VARCHAR(100) NOT NULL;
ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS found_location VARCHAR(50) NOT NULL DEFAULT 'æœªçŸ¥';

-- ç¦ç”¨ RLS
ALTER TABLE lost_items DISABLE ROW LEVEL SECURITY;

-- é‡æ–°æ•´ç† schema cache
NOTIFY pgrst, 'reload schema';`;

            document.getElementById('sqlCommand').textContent = sql;
            document.getElementById('sqlFix').style.display = 'block';
        }

        function generateAddColumnsSQL(missingColumns) {
            const columnDefinitions = {
                'description': 'TEXT',
                'image_url': 'TEXT',
                'image_data': 'TEXT',
                'story': 'TEXT',
                'finder_name': 'VARCHAR(50)',
                'found_time': 'TIMESTAMP WITH TIME ZONE DEFAULT NOW()',
                'created_at': 'TIMESTAMP WITH TIME ZONE DEFAULT NOW()',
                'updated_at': 'TIMESTAMP WITH TIME ZONE DEFAULT NOW()'
            };

            let sql = '-- æ·»åŠ ç¼ºå°‘çš„æ¬„ä½\n';
            missingColumns.forEach(column => {
                const definition = columnDefinitions[column] || 'TEXT';
                sql += `ALTER TABLE lost_items ADD COLUMN IF NOT EXISTS ${column} ${definition};\n`;
            });
            
            sql += '\n-- ç¦ç”¨ RLS\nALTER TABLE lost_items DISABLE ROW LEVEL SECURITY;\n';
            sql += '\n-- é‡æ–°æ•´ç† schema cache\nNOTIFY pgrst, \'reload schema\';';

            document.getElementById('sqlCommand').textContent = sql;
            document.getElementById('sqlFix').style.display = 'block';
        }

        function copySQL() {
            const sql = document.getElementById('sqlCommand').textContent;
            navigator.clipboard.writeText(sql).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²è¤‡è£½ï¼';
                btn.style.background = '#4CAF50';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#2196F3';
                }, 2000);
            });
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', function() {
            setTimeout(checkCurrentStructure, 500);
        });
    </script>
</body>
</html>
