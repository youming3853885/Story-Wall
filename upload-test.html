<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šå‚³åŠŸèƒ½æ¸¬è©¦</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #F44336; }
        .info { border-left: 4px solid #2196F3; }
        .warning { border-left: 4px solid #FF9800; }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 0.8rem 1.5rem; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre { 
            background: #f9f9f9; 
            padding: 1rem; 
            border-radius: 4px; 
            font-size: 0.9rem; 
            overflow-x: auto; 
        }
        input[type="file"] { margin: 1rem 0; }
        .upload-preview {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .test-item {
            background: #f9f9f9;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            border-left: 3px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ä¸Šå‚³åŠŸèƒ½å®Œæ•´æ¸¬è©¦</h1>
    <p>é€™å€‹å·¥å…·æœƒæ¸¬è©¦å®Œæ•´çš„ä¸Šå‚³æµç¨‹ï¼ŒåŒ…æ‹¬ Storage å’Œè³‡æ–™åº«åŠŸèƒ½</p>
    
    <div id="results"></div>
    
    <!-- é€£ç·šæ¸¬è©¦ -->
    <div class="test-section info">
        <h3>ğŸ“¡ æ­¥é©Ÿ 1: é€£ç·šæ¸¬è©¦</h3>
        <button onclick="testConnection()">æ¸¬è©¦ Supabase é€£ç·š</button>
        <div id="connectionResult"></div>
    </div>

    <!-- Storage æ¸¬è©¦ -->
    <div class="test-section info">
        <h3>ğŸ“ æ­¥é©Ÿ 2: Storage Bucket æ¸¬è©¦</h3>
        <button onclick="testStorageBucket()">æ¸¬è©¦ Storage Bucket</button>
        <div id="storageResult"></div>
    </div>

    <!-- åœ–ç‰‡ä¸Šå‚³æ¸¬è©¦ -->
    <div class="test-section info">
        <h3>ğŸ–¼ï¸ æ­¥é©Ÿ 3: åœ–ç‰‡ä¸Šå‚³æ¸¬è©¦</h3>
        <input type="file" id="testImageInput" accept="image/*" onchange="previewImage()">
        <div id="imagePreview"></div>
        <button onclick="testImageUpload()" id="uploadBtn" disabled>æ¸¬è©¦åœ–ç‰‡ä¸Šå‚³</button>
        <div id="uploadResult"></div>
    </div>

    <!-- è³‡æ–™åº«å„²å­˜æ¸¬è©¦ -->
    <div class="test-section info">
        <h3>ğŸ’¾ æ­¥é©Ÿ 4: è³‡æ–™åº«å„²å­˜æ¸¬è©¦</h3>
        <button onclick="testDatabaseSave()" id="saveBtn" disabled>æ¸¬è©¦è³‡æ–™åº«å„²å­˜</button>
        <div id="saveResult"></div>
    </div>

    <!-- é¡¯ç¤ºæ¸¬è©¦ -->
    <div class="test-section info">
        <h3>ğŸ‘ï¸ æ­¥é©Ÿ 5: é¡¯ç¤ºåŠŸèƒ½æ¸¬è©¦</h3>
        <button onclick="testDisplayItems()">æ¸¬è©¦å¤±ç‰©é¡¯ç¤º</button>
        <div id="displayResult"></div>
    </div>

    <script>
        const supabaseUrl = 'https://oytgyizrtuqyxvxtgrlv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dGd5aXpydHVxeXh2eHRncmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUwNjgsImV4cCI6MjA3MTE1MTA2OH0.OiHI8KP-p0OOKo6XvPOARsz0pYqWBEMowJbL0wOzrQs';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        let testImageBlob = null;
        let testImageUrl = null;

        function log(elementId, type, title, content = '') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `test-item ${type}`;
            let html = `<strong>${title}</strong>`;
            if (content) {
                if (typeof content === 'object') {
                    html += `<pre>${JSON.stringify(content, null, 2)}</pre>`;
                } else {
                    html += `<br/>${content}`;
                }
            }
            div.innerHTML = html;
            element.appendChild(div);
        }

        async function testConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = '';
            
            try {
                log('connectionResult', 'info', 'ğŸ” æ¸¬è©¦ Supabase é€£ç·š...');
                
                const { data, error } = await supabase
                    .from('lost_items')
                    .select('count')
                    .limit(1);

                if (error) {
                    log('connectionResult', 'error', 'âŒ è³‡æ–™åº«é€£ç·šå¤±æ•—', error.message);
                } else {
                    log('connectionResult', 'success', 'âœ… Supabase é€£ç·šæˆåŠŸ');
                }
            } catch (err) {
                log('connectionResult', 'error', 'âŒ é€£ç·šæ¸¬è©¦ç•°å¸¸', err.message);
            }
        }

        async function testStorageBucket() {
            const resultDiv = document.getElementById('storageResult');
            resultDiv.innerHTML = '';
            
            try {
                log('storageResult', 'info', 'ğŸ” æ¸¬è©¦ Storage Bucket...');
                
                // æ¸¬è©¦åˆ—å‡º Bucket
                const { data: buckets, error: bucketError } = await supabase.storage.listBuckets();
                
                if (bucketError) {
                    log('storageResult', 'error', 'âŒ ç„¡æ³•åˆ—å‡º Buckets', bucketError.message);
                    return;
                }
                
                const lostItemsBucket = buckets.find(bucket => bucket.name === 'lost-items-images');
                
                if (!lostItemsBucket) {
                    log('storageResult', 'error', 'âŒ lost-items-images Bucket ä¸å­˜åœ¨', 
                        'è«‹å…ˆåœ¨ Supabase Dashboard å‰µå»ºæ­¤ Bucket');
                    return;
                }
                
                log('storageResult', 'success', 'âœ… lost-items-images Bucket å­˜åœ¨');
                
                // æ¸¬è©¦ Bucket æ¬Šé™
                const testFile = new Blob(['test'], { type: 'text/plain' });
                const testFileName = `test-${Date.now()}.txt`;
                
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('lost-items-images')
                    .upload(testFileName, testFile);
                
                if (uploadError) {
                    log('storageResult', 'warning', 'âš ï¸ Storage ä¸Šå‚³æ¬Šé™å•é¡Œ', uploadError.message);
                } else {
                    log('storageResult', 'success', 'âœ… Storage ä¸Šå‚³æ¬Šé™æ­£å¸¸');
                    
                    // æ¸…ç†æ¸¬è©¦æª”æ¡ˆ
                    await supabase.storage
                        .from('lost-items-images')
                        .remove([testFileName]);
                }
                
            } catch (err) {
                log('storageResult', 'error', 'âŒ Storage æ¸¬è©¦ç•°å¸¸', err.message);
            }
        }

        function previewImage() {
            const input = document.getElementById('testImageInput');
            const preview = document.getElementById('imagePreview');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                testImageBlob = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="upload-preview" alt="æ¸¬è©¦åœ–ç‰‡">`;
                };
                reader.readAsDataURL(file);
                
                uploadBtn.disabled = false;
            }
        }

        async function testImageUpload() {
            const resultDiv = document.getElementById('uploadResult');
            resultDiv.innerHTML = '';
            
            if (!testImageBlob) {
                log('uploadResult', 'error', 'âŒ è«‹å…ˆé¸æ“‡åœ–ç‰‡');
                return;
            }
            
            try {
                log('uploadResult', 'info', 'ğŸ” æ¸¬è©¦åœ–ç‰‡ä¸Šå‚³...');
                
                const timestamp = new Date().getTime();
                const fileName = `test-upload/${timestamp}-test-image.jpg`;
                
                const { data, error } = await supabase.storage
                    .from('lost-items-images')
                    .upload(fileName, testImageBlob, {
                        contentType: 'image/jpeg',
                        upsert: false
                    });
                
                if (error) {
                    log('uploadResult', 'error', 'âŒ åœ–ç‰‡ä¸Šå‚³å¤±æ•—', error.message);
                    return;
                }
                
                // ç²å–å…¬é–‹ URL
                const { data: urlData } = supabase.storage
                    .from('lost-items-images')
                    .getPublicUrl(data.path);
                
                testImageUrl = urlData.publicUrl;
                
                log('uploadResult', 'success', 'âœ… åœ–ç‰‡ä¸Šå‚³æˆåŠŸ', `URL: ${testImageUrl}`);
                
                // å•Ÿç”¨ä¸‹ä¸€æ­¥æŒ‰éˆ•
                document.getElementById('saveBtn').disabled = false;
                
            } catch (err) {
                log('uploadResult', 'error', 'âŒ ä¸Šå‚³æ¸¬è©¦ç•°å¸¸', err.message);
            }
        }

        async function testDatabaseSave() {
            const resultDiv = document.getElementById('saveResult');
            resultDiv.innerHTML = '';
            
            if (!testImageUrl) {
                log('saveResult', 'error', 'âŒ è«‹å…ˆå®Œæˆåœ–ç‰‡ä¸Šå‚³æ¸¬è©¦');
                return;
            }
            
            try {
                log('saveResult', 'info', 'ğŸ” æ¸¬è©¦è³‡æ–™åº«å„²å­˜...');
                
                const testData = {
                    name: 'æ¸¬è©¦å¤±ç‰©',
                    description: 'é€™æ˜¯ä¸Šå‚³åŠŸèƒ½æ¸¬è©¦çš„æ¸¬è©¦å¤±ç‰©',
                    image_url: testImageUrl,
                    found_location: 'æ¸¬è©¦åœ°é»',
                    story: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦æ•…äº‹ï¼Œç”¨ä¾†é©—è­‰ä¸Šå‚³åŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œã€‚',
                    finder_name: 'æ¸¬è©¦è€…',
                    found_time: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('lost_items')
                    .insert([testData])
                    .select();

                if (error) {
                    log('saveResult', 'error', 'âŒ è³‡æ–™åº«å„²å­˜å¤±æ•—', error.message);
                    return;
                }

                log('saveResult', 'success', 'âœ… è³‡æ–™åº«å„²å­˜æˆåŠŸ', data[0]);
                
                // å„²å­˜æ¸¬è©¦ ID ä¾›å¾ŒçºŒæ¸…ç†
                window.testItemId = data[0].id;
                
            } catch (err) {
                log('saveResult', 'error', 'âŒ å„²å­˜æ¸¬è©¦ç•°å¸¸', err.message);
            }
        }

        async function testDisplayItems() {
            const resultDiv = document.getElementById('displayResult');
            resultDiv.innerHTML = '';
            
            try {
                log('displayResult', 'info', 'ğŸ” æ¸¬è©¦å¤±ç‰©é¡¯ç¤º...');
                
                const { data, error } = await supabase
                    .from('lost_items')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) {
                    log('displayResult', 'error', 'âŒ è®€å–å¤±ç‰©è³‡æ–™å¤±æ•—', error.message);
                    return;
                }

                if (data.length === 0) {
                    log('displayResult', 'warning', 'âš ï¸ æ²’æœ‰å¤±ç‰©è³‡æ–™');
                } else {
                    log('displayResult', 'success', `âœ… æˆåŠŸè®€å– ${data.length} ç­†å¤±ç‰©è³‡æ–™`);
                    
                    data.forEach((item, index) => {
                        const hasImageUrl = !!item.image_url;
                        const hasImageData = !!item.image_data;
                        const imageInfo = hasImageUrl ? 'æœ‰ Storage URL' : (hasImageData ? 'æœ‰ Base64 è³‡æ–™' : 'ç„¡åœ–ç‰‡');
                        
                        log('displayResult', 'info', `å¤±ç‰© ${index + 1}: ${item.name}`, 
                            `åœ°é»: ${item.found_location} | åœ–ç‰‡: ${imageInfo} | æ•…äº‹: ${item.story ? 'æœ‰' : 'ç„¡'}`);
                    });
                }
                
                // æ¸…ç†æ¸¬è©¦è³‡æ–™
                if (window.testItemId) {
                    log('displayResult', 'info', 'ğŸ§¹ æ¸…ç†æ¸¬è©¦è³‡æ–™...');
                    await supabase
                        .from('lost_items')
                        .delete()
                        .eq('id', window.testItemId);
                    log('displayResult', 'success', 'âœ… æ¸¬è©¦è³‡æ–™å·²æ¸…ç†');
                }
                
            } catch (err) {
                log('displayResult', 'error', 'âŒ é¡¯ç¤ºæ¸¬è©¦ç•°å¸¸', err.message);
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦é€£ç·š
        window.addEventListener('load', function() {
            setTimeout(testConnection, 500);
        });
    </script>
</body>
</html>
