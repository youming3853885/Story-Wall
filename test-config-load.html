<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ç½®è¼‰å…¥è¨ºæ–·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 2rem;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: 500;
        }
        
        .success { background: #e8f5e8; border-left: 4px solid #4CAF50; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .info { background: #e3f2fd; border-left: 4px solid #2196F3; }
        
        .code {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” é…ç½®è¼‰å…¥è¨ºæ–·å·¥å…·</h1>
        <p>é€™å€‹å·¥å…·ç”¨ä¾†è¨ºæ–· config.js è¼‰å…¥å•é¡Œ</p>
        
        <div id="results"></div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function diagnoseConfig() {
            addResult('ğŸš€ é–‹å§‹é…ç½®è¨ºæ–·...');
            
            // æª¢æŸ¥åŸºæœ¬è®Šæ•¸
            addResult(`ğŸ“‹ åŸºæœ¬æª¢æŸ¥ï¼š
â€¢ window å°è±¡å­˜åœ¨: ${typeof window !== 'undefined'}
â€¢ document å°è±¡å­˜åœ¨: ${typeof document !== 'undefined'}
â€¢ ç•¶å‰ URL: ${window.location.href}`);

            // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
            window.addEventListener('error', function(e) {
                addResult(`âŒ JavaScript éŒ¯èª¤: ${e.message}
æ–‡ä»¶: ${e.filename}
è¡Œè™Ÿ: ${e.lineno}`, 'error');
            });

            // åœ¨è¼‰å…¥ config.js ä¹‹å‰æª¢æŸ¥
            addResult('â³ æº–å‚™è¼‰å…¥ config.js...');
            
            // å‹•æ…‹è¼‰å…¥ config.js ä¸¦æª¢æŸ¥
            const script = document.createElement('script');
            script.src = 'config.js';
            script.onload = function() {
                addResult('âœ… config.js è¼‰å…¥å®Œæˆ', 'success');
                checkConfigAfterLoad();
            };
            script.onerror = function() {
                addResult('âŒ config.js è¼‰å…¥å¤±æ•—', 'error');
                addResult('å¯èƒ½åŸå› ï¼š<br>â€¢ æ–‡ä»¶ä¸å­˜åœ¨<br>â€¢ è·¯å¾‘éŒ¯èª¤<br>â€¢ æ–‡ä»¶èªæ³•éŒ¯èª¤<br>â€¢ ä¼ºæœå™¨å•é¡Œ', 'error');
            };
            
            document.head.appendChild(script);
        }

        function checkConfigAfterLoad() {
            addResult('ğŸ” æª¢æŸ¥è¼‰å…¥å¾Œçš„é…ç½®ç‹€æ…‹ï¼š');
            
            // æª¢æŸ¥ window.LostItemsConfig
            if (typeof window.LostItemsConfig !== 'undefined') {
                addResult('âœ… window.LostItemsConfig å·²å®šç¾©', 'success');
                
                const config = window.LostItemsConfig;
                addResult(`ğŸ“Š é…ç½®å…§å®¹ï¼š
â€¢ config å­˜åœ¨: ${typeof config.config !== 'undefined'}
â€¢ storyPrompts å­˜åœ¨: ${typeof config.storyPrompts !== 'undefined'}
â€¢ locationMap å­˜åœ¨: ${typeof config.locationMap !== 'undefined'}`);

                if (config.config) {
                    addResult(`ğŸ”§ Supabase é…ç½®ï¼š
â€¢ URL: ${config.config.supabase?.url || 'æœªè¨­å®š'}
â€¢ Key é•·åº¦: ${config.config.supabase?.anonKey?.length || 0} å­—ç¬¦
â€¢ Key é–‹é ­: ${config.config.supabase?.anonKey?.substring(0, 20) || 'ç„¡'}...`);
                }

                // é¡¯ç¤ºå®Œæ•´é…ç½®çµæ§‹
                addResult(`ğŸ“„ å®Œæ•´é…ç½®çµæ§‹ï¼š`, 'info');
                const codeDiv = document.createElement('div');
                codeDiv.className = 'code';
                codeDiv.textContent = JSON.stringify(config, null, 2);
                document.getElementById('results').appendChild(codeDiv);

            } else {
                addResult('âŒ window.LostItemsConfig æœªå®šç¾©', 'error');
                
                // æª¢æŸ¥å¯èƒ½çš„å…¨åŸŸè®Šæ•¸
                addResult('ğŸ” æª¢æŸ¥å…¶ä»–å¯èƒ½çš„å…¨åŸŸè®Šæ•¸ï¼š');
                const globalVars = ['CONFIG', 'getConfig', 'STORY_PROMPTS', 'LOCATION_MAP'];
                globalVars.forEach(varName => {
                    addResult(`â€¢ window.${varName}: ${typeof window[varName] !== 'undefined' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                });
            }

            // æ¸¬è©¦ Supabase CDN
            addResult('ğŸ”— æ¸¬è©¦ Supabase CDN è¼‰å…¥ï¼š');
            loadSupabaseAndTest();
        }

        function loadSupabaseAndTest() {
            if (typeof window.supabase !== 'undefined') {
                addResult('âœ… Supabase CDN å·²è¼‰å…¥', 'success');
                testSupabaseConnection();
            } else {
                addResult('â³ è¼‰å…¥ Supabase CDN...');
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@supabase/supabase-js@2';
                script.onload = function() {
                    addResult('âœ… Supabase CDN è¼‰å…¥æˆåŠŸ', 'success');
                    testSupabaseConnection();
                };
                script.onerror = function() {
                    addResult('âŒ Supabase CDN è¼‰å…¥å¤±æ•—', 'error');
                };
                document.head.appendChild(script);
            }
        }

        function testSupabaseConnection() {
            if (typeof window.LostItemsConfig !== 'undefined' && window.LostItemsConfig.config) {
                try {
                    const config = window.LostItemsConfig.config;
                    const supabase = window.supabase.createClient(config.supabase.url, config.supabase.anonKey);
                    addResult('âœ… Supabase å®¢æˆ¶ç«¯å‰µå»ºæˆåŠŸ', 'success');
                    
                    // æ¸¬è©¦ç°¡å–®æŸ¥è©¢
                    supabase.from('lost_items').select('count', { count: 'exact', head: true })
                        .then(({ data, error }) => {
                            if (error) {
                                addResult(`âš ï¸ è³‡æ–™åº«æŸ¥è©¢æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                            } else {
                                addResult('âœ… è³‡æ–™åº«é€£æ¥æ¸¬è©¦æˆåŠŸ', 'success');
                            }
                        })
                        .catch(err => {
                            addResult(`âŒ è³‡æ–™åº«é€£æ¥æ¸¬è©¦éŒ¯èª¤: ${err.message}`, 'error');
                        });
                        
                } catch (err) {
                    addResult(`âŒ Supabase å®¢æˆ¶ç«¯å‰µå»ºå¤±æ•—: ${err.message}`, 'error');
                }
            } else {
                addResult('âŒ ç„¡æ³•æ¸¬è©¦ Supabase é€£æ¥ï¼Œé…ç½®ä¸å®Œæ•´', 'error');
            }
        }

        // é–‹å§‹è¨ºæ–·
        document.addEventListener('DOMContentLoaded', function() {
            addResult('ğŸ“– é é¢è¼‰å…¥å®Œæˆ');
            setTimeout(diagnoseConfig, 100); // ç¨å¾®å»¶é²åŸ·è¡Œ
        });
    </script>
</body>
</html>
