<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦è³‡æ–™åº«é¡¯ç¤ºåŠŸèƒ½</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 2rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #F44336; }
        .info { border-left: 4px solid #2196F3; }
        .warning { border-left: 4px solid #FF9800; }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #45a049; }
        
        .log {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .log .success { color: #4CAF50; }
        .log .error { color: #F44336; }
        .log .warning { color: #FF9800; }
        .log .info { color: #2196F3; }
        
        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .mini-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
        }
        
        .mini-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .mini-card h4 {
            margin: 0.5rem 0;
            color: #333;
        }
        
        .mini-card p {
            margin: 0.25rem 0;
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ¸¬è©¦è³‡æ–™åº«é¡¯ç¤ºåŠŸèƒ½</h1>
    
    <div class="test-section info">
        <h3>ğŸ“Š æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹</h3>
        <p>é¦–å…ˆæª¢æŸ¥è³‡æ–™åº«ä¸­çš„å¤±ç‰©è³‡æ–™ï¼š</p>
        <button onclick="checkDatabaseData()">æª¢æŸ¥ lost_items è¡¨</button>
        <div id="databaseResults"></div>
    </div>

    <div class="test-section info">
        <h3>ğŸ¨ æ¸¬è©¦é¡¯ç¤ºé‚è¼¯</h3>
        <p>æ¸¬è©¦å¤±ç‰©å¡ç‰‡çš„æ¸²æŸ“å’Œé¡¯ç¤ºé‚è¼¯ï¼š</p>
        <button onclick="testDisplayLogic()">æ¸¬è©¦é¡¯ç¤ºåŠŸèƒ½</button>
        <div id="displayResults"></div>
    </div>

    <div class="test-section info">
        <h3>ğŸ“± é è¦½æ•ˆæœ</h3>
        <p>æŸ¥çœ‹å¯¦éš›çš„å¤±ç‰©å¡ç‰‡é¡¯ç¤ºæ•ˆæœï¼š</p>
        <button onclick="previewCards()">é è¦½å¤±ç‰©å¡ç‰‡</button>
        <div id="previewArea"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <script src="config.js"></script>
    <script>
        // åˆå§‹åŒ– Supabase
        let supabase;
        
        if (typeof window.LostItemsConfig !== 'undefined') {
            const config = window.LostItemsConfig.config;
            supabase = window.supabase.createClient(config.supabase.url, config.supabase.anonKey);
        } else {
            const supabaseUrl = 'https://oytgyizrtuqyxvxtgrlv.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dGd5aXpydHVxeXh2eHRncmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUwNjgsImV4cCI6MjA3MTE1MTA2OH0.OiHI8KP-p0OOKo6XvPOARsz0pYqWBEMowJbL0wOzrQs';
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : type === 'info' ? 'info' : '';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function addResult(elementId, type, title, content) {
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<h4>${title}</h4>${content}`;
            document.getElementById(elementId).appendChild(div);
        }

        async function checkDatabaseData() {
            document.getElementById('databaseResults').innerHTML = '';
            log('ğŸ” æª¢æŸ¥è³‡æ–™åº«è³‡æ–™...');
            
            try {
                const { data, error } = await supabase
                    .from('lost_items')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    log(`âŒ è³‡æ–™åº«æŸ¥è©¢å¤±æ•—: ${error.message}`, 'error');
                    addResult('databaseResults', 'error', 'âŒ è³‡æ–™åº«æŸ¥è©¢å¤±æ•—', error.message);
                    return;
                }

                log(`âœ… æˆåŠŸæŸ¥è©¢åˆ° ${data.length} ç­†è³‡æ–™`, 'success');

                if (data.length === 0) {
                    addResult('databaseResults', 'warning', 'âš ï¸ è³‡æ–™åº«ç‚ºç©º', 
                        'ç›®å‰ lost_items è¡¨ä¸­æ²’æœ‰è³‡æ–™ã€‚<br>è«‹å…ˆä½¿ç”¨ä¸Šå‚³åŠŸèƒ½æ·»åŠ ä¸€äº›å¤±ç‰©è³‡æ–™ã€‚');
                } else {
                    let content = `<p>æ‰¾åˆ° ${data.length} ç­†å¤±ç‰©è³‡æ–™ï¼š</p><ul>`;
                    data.forEach((item, index) => {
                        const hasImage = item.image_url || item.image_data;
                        const imageInfo = item.image_url ? 'Storage URL' : (item.image_data ? 'Base64' : 'ç„¡åœ–ç‰‡');
                        content += `<li><strong>${item.name}</strong> - ${item.found_location} (${imageInfo})</li>`;
                    });
                    content += '</ul>';
                    
                    addResult('databaseResults', 'success', 'âœ… è³‡æ–™åº«è³‡æ–™æ­£å¸¸', content);
                }

            } catch (err) {
                log(`âŒ æª¢æŸ¥éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${err.message}`, 'error');
                addResult('databaseResults', 'error', 'âŒ æª¢æŸ¥ç•°å¸¸', err.message);
            }
        }

        async function testDisplayLogic() {
            document.getElementById('displayResults').innerHTML = '';
            log('ğŸ¨ æ¸¬è©¦é¡¯ç¤ºé‚è¼¯...');
            
            try {
                // æ¸¬è©¦è¼‰å…¥åŠŸèƒ½
                log('æ¸¬è©¦ loadLostItemsFromDatabase å‡½æ•¸...');
                
                // æ¨¡æ“¬è¼‰å…¥éç¨‹
                const { data, error } = await supabase
                    .from('lost_items')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    log(`âŒ è¼‰å…¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                    addResult('displayResults', 'error', 'âŒ è¼‰å…¥é‚è¼¯æ¸¬è©¦å¤±æ•—', error.message);
                    return;
                }

                log('âœ… è¼‰å…¥é‚è¼¯æ¸¬è©¦æˆåŠŸ', 'success');
                
                // æ¸¬è©¦å¡ç‰‡å‰µå»º
                if (data.length > 0) {
                    log('æ¸¬è©¦å¡ç‰‡å‰µå»ºé‚è¼¯...');
                    
                    const testItem = data[0];
                    log(`æ¸¬è©¦é …ç›®: ${testItem.name}`);
                    
                    // æª¢æŸ¥å¿…è¦æ¬„ä½
                    const requiredFields = ['id', 'name', 'found_location'];
                    const missingFields = requiredFields.filter(field => !testItem[field]);
                    
                    if (missingFields.length > 0) {
                        log(`âŒ ç¼ºå°‘å¿…è¦æ¬„ä½: ${missingFields.join(', ')}`, 'error');
                        addResult('displayResults', 'error', 'âŒ è³‡æ–™çµæ§‹å•é¡Œ', 
                            `ç¼ºå°‘å¿…è¦æ¬„ä½: ${missingFields.join(', ')}`);
                        return;
                    }
                    
                    log('âœ… è³‡æ–™çµæ§‹é©—è­‰é€šé', 'success');
                    addResult('displayResults', 'success', 'âœ… é¡¯ç¤ºé‚è¼¯æ¸¬è©¦é€šé', 
                        `è³‡æ–™è¼‰å…¥å’Œå¡ç‰‡å‰µå»ºé‚è¼¯éƒ½æ­£å¸¸é‹ä½œ<br>æ¸¬è©¦é …ç›®: ${testItem.name}`);
                } else {
                    addResult('displayResults', 'warning', 'âš ï¸ ç„¡æ³•æ¸¬è©¦å¡ç‰‡é‚è¼¯', 
                        'è³‡æ–™åº«ä¸­æ²’æœ‰è³‡æ–™ï¼Œç„¡æ³•æ¸¬è©¦å¡ç‰‡å‰µå»ºé‚è¼¯');
                }

            } catch (err) {
                log(`âŒ é¡¯ç¤ºé‚è¼¯æ¸¬è©¦ç•°å¸¸: ${err.message}`, 'error');
                addResult('displayResults', 'error', 'âŒ æ¸¬è©¦ç•°å¸¸', err.message);
            }
        }

        // è¤‡è£½ä¸»è¦çš„å¤±ç‰©å¡ç‰‡å‰µå»ºå‡½æ•¸
        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.onclick = () => log(`é»æ“Šäº†å¤±ç‰©: ${item.name}`);
            
            // å„ªå…ˆä½¿ç”¨ image_urlï¼Œå†ä½¿ç”¨ image_dataï¼Œæœ€å¾Œä½¿ç”¨é è¨­åœ–ç‰‡
            const imageSource = item.image_url || item.image_data || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"%3E%3Crect width="200" height="200" fill="%23F0F0F0"/%3E%3Ctext x="100" y="100" text-anchor="middle" font-family="Arial" font-size="16" fill="%23999"%3Eç„¡åœ–ç‰‡%3C/text%3E%3C/svg%3E';
            
            const timeString = formatTimeFromDatabase(item.found_time || item.created_at || new Date().toISOString());
            
            // å®‰å…¨è™•ç†å¯èƒ½çš„ç©ºå€¼
            const itemName = item.name || 'æœªçŸ¥å¤±ç‰©';
            const foundLocation = item.found_location || 'æœªçŸ¥åœ°é»';
            const description = item.description ? ` - ${item.description}` : '';
            
            card.innerHTML = `
                <div class="item-image-container">
                    <img src="${imageSource}" alt="${itemName}" class="item-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 200 200&quot;%3E%3Crect width=&quot;200&quot; height=&quot;200&quot; fill=&quot;%23F0F0F0&quot;/%3E%3Ctext x=&quot;100&quot; y=&quot;100&quot; text-anchor=&quot;middle&quot; font-family=&quot;Arial&quot; font-size=&quot;16&quot; fill=&quot;%23999&quot;%3Eåœ–ç‰‡è¼‰å…¥å¤±æ•—%3C/text%3E%3C/svg%3E'">
                    <div class="story-indicator">
                        <svg class="play-icon" viewBox="0 0 24 24" width="24" height="24">
                            <path d="M8 5v14l11-7z" fill="#fff"/>
                        </svg>
                    </div>
                </div>
                <div class="item-info">
                    <h3 class="item-name">${itemName}</h3>
                    <p class="item-date">ç™¼ç¾æ–¼ï¼š${timeString}</p>
                    <p class="item-location">ğŸ“ ${foundLocation}</p>
                    ${description ? `<p class="item-description">${description}</p>` : ''}
                </div>
            `;
            
            return card;
        }

        function formatTimeFromDatabase(timeString) {
            const date = new Date(timeString);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'ä»Šå¤©';
            if (diffDays === 1) return 'æ˜¨å¤©';
            if (diffDays === 2) return 'å‰å¤©';
            if (diffDays <= 7) return `${diffDays}å¤©å‰`;
            return `${Math.floor(diffDays / 7)}é€±å‰`;
        }

        async function previewCards() {
            document.getElementById('previewArea').innerHTML = '';
            log('ğŸ‘ï¸ ç”Ÿæˆé è¦½å¡ç‰‡...');
            
            try {
                const { data, error } = await supabase
                    .from('lost_items')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(6);

                if (error) {
                    log(`âŒ é è¦½è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                    return;
                }

                if (data.length === 0) {
                    document.getElementById('previewArea').innerHTML = `
                        <div class="test-section warning">
                            <h4>âš ï¸ ç„¡æ³•ç”Ÿæˆé è¦½</h4>
                            <p>è³‡æ–™åº«ä¸­æ²’æœ‰å¤±ç‰©è³‡æ–™ï¼Œè«‹å…ˆä¸Šå‚³ä¸€äº›å¤±ç‰©ã€‚</p>
                        </div>
                    `;
                    return;
                }

                log(`âœ… è¼‰å…¥äº† ${data.length} ç­†è³‡æ–™ç”¨æ–¼é è¦½`, 'success');
                
                const previewHTML = `
                    <div class="test-section success">
                        <h4>âœ… å¤±ç‰©å¡ç‰‡é è¦½ï¼ˆå‰ ${data.length} ç­†ï¼‰</h4>
                        <div class="demo-grid">
                            ${data.map(item => `
                                <div class="mini-card">
                                    <img src="${item.image_url || item.image_data || 'data:image/svg+xml,%3Csvg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 200 200&quot;%3E%3Crect width=&quot;200&quot; height=&quot;200&quot; fill=&quot;%23F0F0F0&quot;/%3E%3Ctext x=&quot;100&quot; y=&quot;100&quot; text-anchor=&quot;middle&quot; font-family=&quot;Arial&quot; font-size=&quot;16&quot; fill=&quot;%23999&quot;%3Eç„¡åœ–ç‰‡%3C/text%3E%3C/svg%3E'}" alt="${item.name}">
                                    <h4>${item.name}</h4>
                                    <p>ğŸ“ ${item.found_location}</p>
                                    <p>ğŸ•’ ${formatTimeFromDatabase(item.found_time || item.created_at)}</p>
                                    <p>ğŸ“– ${item.story ? 'æœ‰æ•…äº‹' : 'ç„¡æ•…äº‹'}</p>
                                </div>
                            `).join('')}
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                            é€™äº›æ˜¯å¾ lost_items è¡¨è¼‰å…¥çš„çœŸå¯¦è³‡æ–™é è¦½
                        </p>
                    </div>
                `;
                
                document.getElementById('previewArea').innerHTML = previewHTML;
                log('âœ… é è¦½å¡ç‰‡ç”Ÿæˆå®Œæˆ', 'success');

            } catch (err) {
                log(`âŒ é è¦½ç”Ÿæˆç•°å¸¸: ${err.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', function() {
            log('ğŸ§ª æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
            setTimeout(checkDatabaseData, 500);
        });
    </script>
</body>
</html>
