<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase é€£æ¥è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #4285f4;
            margin: 0;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4285f4;
        }
        .btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .log {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .config-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Supabase é€£æ¥è¨ºæ–·å·¥å…·</h1>
            <p>è¨ºæ–·å’Œä¿®å¾© Supabase é€£æ¥å•é¡Œ</p>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ ç•¶å‰é…ç½®</h3>
            <div class="config-display" id="configDisplay">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª é€£æ¥æ¸¬è©¦</h3>
            <button class="btn" onclick="testBasicConnection()">åŸºæœ¬é€£æ¥æ¸¬è©¦</button>
            <button class="btn" onclick="testDatabaseAccess()">è³‡æ–™åº«å­˜å–æ¸¬è©¦</button>
            <button class="btn" onclick="testStorageAccess()">å„²å­˜ç©ºé–“æ¸¬è©¦</button>
            <button class="btn" onclick="exportData()">åŒ¯å‡ºç¾æœ‰è³‡æ–™</button>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š è³‡æ–™åŒ¯å‡º</h3>
            <p>å¦‚æœSupabaseé€£æ¥æœ‰å•é¡Œï¼Œæ‚¨å¯ä»¥æ‰‹å‹•åŒ¯å‡ºè³‡æ–™ï¼š</p>
            <button class="btn" onclick="showManualExport()">é¡¯ç¤ºæ‰‹å‹•åŒ¯å‡ºæŒ‡å—</button>
            <div id="manualExportGuide" style="display: none;">
                <div class="info">
                    <h4>æ‰‹å‹•åŒ¯å‡ºæ­¥é©Ÿï¼š</h4>
                    <ol>
                        <li>å‰å¾€ <a href="https://supabase.com/dashboard" target="_blank">Supabase æ§åˆ¶å°</a></li>
                        <li>é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ</li>
                        <li>å·¦å´é¸å–® â†’ SQL Editor</li>
                        <li>åŸ·è¡Œä»¥ä¸‹SQLæŸ¥è©¢ï¼š</li>
                    </ol>
                    <div class="config-display">
-- åŒ¯å‡ºå¤±ç‰©è³‡æ–™
SELECT * FROM lost_items ORDER BY created_at DESC;

-- åŒ¯å‡ºå·²æ­¸é‚„è³‡æ–™ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
SELECT * FROM returned_items ORDER BY returned_at DESC;
                    </div>
                    <p>å°‡æŸ¥è©¢çµæœè¤‡è£½ä¸¦è²¼åˆ°ä¸‹æ–¹æ–‡å­—æ¡†ï¼Œç„¶å¾Œé»æ“Šã€Œè™•ç†åŒ¯å‡ºè³‡æ–™ã€</p>
                </div>
                <textarea id="exportedData" placeholder="è«‹è²¼ä¸Šå¾SupabaseåŒ¯å‡ºçš„JSONè³‡æ–™..." rows="10" style="width: 100%; margin: 10px 0; padding: 10px; border-radius: 5px; border: 1px solid #ddd;"></textarea>
                <button class="btn" onclick="processExportedData()">è™•ç†åŒ¯å‡ºè³‡æ–™</button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ è¨ºæ–·æ—¥èªŒ</h3>
            <div class="log" id="diagnosticLog">ç­‰å¾…é–‹å§‹è¨ºæ–·...</div>
        </div>

        <div class="test-section">
            <h3>ğŸš€ ç›´æ¥ä½¿ç”¨Firebase</h3>
            <p>å¦‚æœSupabaseæŒçºŒæœ‰å•é¡Œï¼Œæ‚¨å¯ä»¥ç›´æ¥é–‹å§‹ä½¿ç”¨Firebaseï¼š</p>
            <button class="btn" onclick="window.open('firebase-test.html', '_blank')">é–‹å•ŸFirebaseæ¸¬è©¦é é¢</button>
            <div class="info">
                <p><strong>å»ºè­°ï¼š</strong>å³ä½¿æ²’æœ‰èˆŠè³‡æ–™ï¼Œæ‚¨ä¹Ÿå¯ä»¥ç›´æ¥é–‹å§‹ä½¿ç”¨Firebaseç‰ˆæœ¬ã€‚Firebaseæä¾›æ›´ç©©å®šçš„æœå‹™ï¼Œè€Œä¸”æ‚¨å¯ä»¥éš¨æ™‚æ‰‹å‹•é‡æ–°è¼¸å…¥é‡è¦çš„å¤±ç‰©è³‡æ–™ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // Supabase é…ç½®
        const supabaseConfig = {
            url: 'https://oytgyizrtuqyxvxtgrlv.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dGd5aXpydHVxeXh2eHRncmx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NzUwNjgsImV4cCI6MjA3MTE1MTA2OH0.OiHI8KP-p0OOKo6XvPOARsz0pYqWBEMowJbL0wOzrQs'
        };

        let supabase;

        function log(message, type = 'info') {
            const logElement = document.getElementById('diagnosticLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message);
        }

        function showResult(message, type = 'info') {
            const resultsElement = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = type;
            resultDiv.textContent = message;
            resultsElement.appendChild(resultDiv);
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºé…ç½®
        window.addEventListener('load', () => {
            const configElement = document.getElementById('configDisplay');
            configElement.innerHTML = `
URL: ${supabaseConfig.url}<br>
API Key: ${supabaseConfig.anonKey.substring(0, 20)}...ï¼ˆå·²éš±è—ï¼‰<br>
ç‹€æ…‹: ç­‰å¾…æ¸¬è©¦
            `;
            
            log('ğŸ“± Supabase è¨ºæ–·å·¥å…·å·²æº–å‚™å°±ç·’');
        });

        async function testBasicConnection() {
            log('ğŸ” é–‹å§‹åŸºæœ¬é€£æ¥æ¸¬è©¦...');
            
            try {
                // åˆå§‹åŒ– Supabase
                supabase = window.supabase.createClient(supabaseConfig.url, supabaseConfig.anonKey);
                log('âœ… Supabase å®¢æˆ¶ç«¯åˆå§‹åŒ–æˆåŠŸ');
                
                // æ¸¬è©¦åŸºæœ¬é€£æ¥
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`âš ï¸ èªè­‰æ¸¬è©¦è­¦å‘Š: ${error.message}`);
                } else {
                    log('âœ… åŸºæœ¬é€£æ¥æ¸¬è©¦é€šé');
                }
                
                showResult('åŸºæœ¬é€£æ¥æ¸¬è©¦å®Œæˆ', 'success');
                
            } catch (error) {
                log(`âŒ åŸºæœ¬é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`);
                showResult(`åŸºæœ¬é€£æ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testDatabaseAccess() {
            log('ğŸ—„ï¸ é–‹å§‹è³‡æ–™åº«å­˜å–æ¸¬è©¦...');
            
            if (!supabase) {
                await testBasicConnection();
            }
            
            try {
                // æ¸¬è©¦è®€å–æ¬Šé™
                const { data, error, count } = await supabase
                    .from('lost_items')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    log(`âŒ è³‡æ–™åº«è®€å–å¤±æ•—: ${error.message}`);
                    showResult(`è³‡æ–™åº«å­˜å–å¤±æ•—: ${error.message}`, 'error');
                    
                    // æä¾›è©³ç´°éŒ¯èª¤è³‡è¨Š
                    if (error.code === 'PGRST116') {
                        log('ğŸ’¡ éŒ¯èª¤åŸå› ï¼šlost_items è¡¨ä¸å­˜åœ¨');
                        showResult('lost_items è¡¨ä¸å­˜åœ¨ï¼Œé€™æ˜¯æ­£å¸¸çš„å¦‚æœæ‚¨é‚„æ²’æœ‰å¤±ç‰©è³‡æ–™', 'info');
                    } else if (error.code === '42501') {
                        log('ğŸ’¡ éŒ¯èª¤åŸå› ï¼šæ¬Šé™ä¸è¶³ï¼Œè«‹æª¢æŸ¥RLSè¨­å®š');
                        showResult('æ¬Šé™ä¸è¶³ï¼Œè«‹æª¢æŸ¥ Supabase RLS è¨­å®š', 'error');
                    }
                } else {
                    log(`âœ… è³‡æ–™åº«å­˜å–æˆåŠŸï¼Œæ‰¾åˆ° ${count || 0} ç­†å¤±ç‰©è³‡æ–™`);
                    showResult(`è³‡æ–™åº«å­˜å–æˆåŠŸï¼Œå…± ${count || 0} ç­†è³‡æ–™`, 'success');
                }
                
            } catch (error) {
                log(`âŒ è³‡æ–™åº«æ¸¬è©¦ç•°å¸¸: ${error.message}`);
                showResult(`è³‡æ–™åº«æ¸¬è©¦ç•°å¸¸: ${error.message}`, 'error');
            }
        }

        async function testStorageAccess() {
            log('ğŸ“ é–‹å§‹å„²å­˜ç©ºé–“æ¸¬è©¦...');
            
            if (!supabase) {
                await testBasicConnection();
            }
            
            try {
                // æ¸¬è©¦å„²å­˜ç©ºé–“åˆ—è¡¨
                const { data, error } = await supabase.storage.listBuckets();
                
                if (error) {
                    log(`âŒ å„²å­˜ç©ºé–“å­˜å–å¤±æ•—: ${error.message}`);
                    showResult(`å„²å­˜ç©ºé–“å­˜å–å¤±æ•—: ${error.message}`, 'error');
                } else {
                    log(`âœ… å„²å­˜ç©ºé–“å­˜å–æˆåŠŸï¼Œæ‰¾åˆ° ${data.length} å€‹ bucket`);
                    showResult(`å„²å­˜ç©ºé–“å­˜å–æˆåŠŸï¼Œå…± ${data.length} å€‹ bucket`, 'success');
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ lost-items-images bucket
                    const hasImagesBucket = data.some(bucket => bucket.name === 'lost-items-images');
                    if (hasImagesBucket) {
                        log('âœ… æ‰¾åˆ° lost-items-images bucket');
                    } else {
                        log('âš ï¸ æœªæ‰¾åˆ° lost-items-images bucket');
                    }
                }
                
            } catch (error) {
                log(`âŒ å„²å­˜ç©ºé–“æ¸¬è©¦ç•°å¸¸: ${error.message}`);
                showResult(`å„²å­˜ç©ºé–“æ¸¬è©¦ç•°å¸¸: ${error.message}`, 'error');
            }
        }

        async function exportData() {
            log('ğŸ“¤ é–‹å§‹åŒ¯å‡ºè³‡æ–™...');
            
            if (!supabase) {
                await testBasicConnection();
            }
            
            try {
                // åŒ¯å‡ºå¤±ç‰©è³‡æ–™
                const { data: lostItems, error: lostError } = await supabase
                    .from('lost_items')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (lostError && lostError.code !== 'PGRST116') {
                    throw new Error(`å¤±ç‰©è³‡æ–™åŒ¯å‡ºå¤±æ•—: ${lostError.message}`);
                }
                
                // åŒ¯å‡ºå·²æ­¸é‚„è³‡æ–™
                const { data: returnedItems, error: returnedError } = await supabase
                    .from('returned_items')
                    .select('*')
                    .order('returned_at', { ascending: false });
                
                if (returnedError && returnedError.code !== 'PGRST116') {
                    log(`âš ï¸ å·²æ­¸é‚„è³‡æ–™åŒ¯å‡ºè­¦å‘Š: ${returnedError.message}`);
                }
                
                const exportData = {
                    lost_items: lostItems || [],
                    returned_items: returnedItems || [],
                    export_time: new Date().toISOString(),
                    total_items: (lostItems?.length || 0) + (returnedItems?.length || 0)
                };
                
                log(`âœ… è³‡æ–™åŒ¯å‡ºæˆåŠŸï¼šå¤±ç‰© ${lostItems?.length || 0} ç­†ï¼Œå·²æ­¸é‚„ ${returnedItems?.length || 0} ç­†`);
                
                // ä¸‹è¼‰ JSON æª”æ¡ˆ
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `supabase-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showResult(`è³‡æ–™åŒ¯å‡ºæˆåŠŸï¼Œå·²ä¸‹è¼‰ JSON æª”æ¡ˆ`, 'success');
                
                // å¦‚æœæœ‰è³‡æ–™ï¼Œæä¾› Firebase åŒ¯å…¥é¸é …
                if (exportData.total_items > 0) {
                    showResult(`ç™¼ç¾ ${exportData.total_items} ç­†è³‡æ–™ï¼Œå»ºè­°ä½¿ç”¨ Firebase åŒ¯å…¥å·¥å…·`, 'info');
                }
                
            } catch (error) {
                log(`âŒ è³‡æ–™åŒ¯å‡ºå¤±æ•—: ${error.message}`);
                showResult(`è³‡æ–™åŒ¯å‡ºå¤±æ•—: ${error.message}`, 'error');
            }
        }

        function showManualExport() {
            const guideElement = document.getElementById('manualExportGuide');
            guideElement.style.display = guideElement.style.display === 'none' ? 'block' : 'none';
            log('ğŸ“– é¡¯ç¤ºæ‰‹å‹•åŒ¯å‡ºæŒ‡å—');
        }

        function processExportedData() {
            const exportedData = document.getElementById('exportedData').value.trim();
            
            if (!exportedData) {
                showResult('è«‹å…ˆè²¼ä¸ŠåŒ¯å‡ºçš„è³‡æ–™', 'error');
                return;
            }
            
            try {
                const data = JSON.parse(exportedData);
                log(`âœ… æˆåŠŸè§£æåŒ¯å‡ºè³‡æ–™ï¼Œå…± ${Array.isArray(data) ? data.length : Object.keys(data).length} ç­†è¨˜éŒ„`);
                
                // å»ºç«‹ä¸‹è¼‰é€£çµ
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `processed-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showResult('è³‡æ–™è™•ç†å®Œæˆï¼Œå·²ä¸‹è¼‰è™•ç†å¾Œçš„æª”æ¡ˆ', 'success');
                showResult('ç¾åœ¨å¯ä»¥ä½¿ç”¨é€™å€‹æª”æ¡ˆåœ¨ Firebase åŒ¯å…¥å·¥å…·ä¸­åŒ¯å…¥è³‡æ–™', 'info');
                
            } catch (error) {
                log(`âŒ è³‡æ–™è§£æå¤±æ•—: ${error.message}`);
                showResult(`è³‡æ–™æ ¼å¼éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
